<!DOCTYPE html>
<html>
<head>
    <title>Stock Chart - AI Driven Trading Platform</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0f172a;
            color: #e2e8f0;
            position: relative;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(96, 165, 250, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 20%);
        }

        /* Chart Background Container */
        .chart-background {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
            z-index: -1;
            opacity: 0.2;
        }

        .chart-container-bg {
            position: absolute;
            width: 150%;
            height: 150%;
            top: -25%;
            left: -25%;
        }

        .grid-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.15) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 1;
        }

        .pulse-circle {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(96, 165, 250, 0.4);
            animation: pulse 5s infinite;
            z-index: 1;
        }

        .pulse-circle:nth-child(1) {
            width: 400px;
            height: 400px;
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }

        .pulse-circle:nth-child(2) {
            width: 600px;
            height: 600px;
            bottom: -250px;
            right: -250px;
            animation-delay: 2.5s;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.1;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.4;
            }
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 15px 20px;
            border-radius: 16px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            padding: 10px 18px;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 500;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid transparent;
            backdrop-filter: blur(5px);
        }

        .nav-links a:hover, .nav-links a.active {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            color: #60a5fa;
            border: 1px solid #60a5fa;
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
        }

        .chart-section {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            backdrop-filter: blur(10px);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stock-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stock-company {
            font-size: 18px;
            color: #94a3b8;
            font-weight: 500;
        }

        .stock-price-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stock-price-large {
            font-size: 42px;
            font-weight: 800;
            color: #e2e8f0;
            text-shadow: 0 0 15px rgba(96, 165, 250, 0.4);
        }

        .stock-change-large {
            font-size: 24px;
            font-weight: 700;
        }

        .stock-info h2 {
            font-size: 32px;
            color: #e2e8f0;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .stock-symbol {
            font-size: 22px;
            color: #94a3b8;
            font-weight: 500;
        }

        .stock-price {
            font-size: 42px;
            font-weight: 800;
            color: #60a5fa;
            margin: 15px 0;
            text-shadow: 0 0 20px rgba(96, 165, 250, 0.6);
        }

        .price-change {
            font-size: 22px;
            font-weight: 700;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }
        
        .prediction-positive {
            color: #10b981;
            font-weight: 700;
        }
        
        .prediction-negative {
            color: #ef4444;
            font-weight: 700;
        }
        
        .prediction-neutral {
            color: #94a3b8;
            font-weight: 700;
        }

        .time-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .indicator-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 18px;
        }

        .indicator-btn {
            background: rgba(51, 65, 85, 0.8);
            color: #94a3b8;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            border: 1px solid transparent;
            backdrop-filter: blur(5px);
        }

        .indicator-btn.active, .indicator-btn:hover {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            border: 1px solid #93c5fd;
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.4);
        }

        .time-btn {
            background: rgba(51, 65, 85, 0.8);
            color: #94a3b8;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
            border: 1px solid transparent;
            backdrop-filter: blur(5px);
        }

        .time-btn.active, .time-btn:hover {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            border: 1px solid #93c5fd;
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.4);
        }

        .chart-container {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            padding: 20px;
            height: 550px;
            border: 1px solid #334155;
            margin-bottom: 25px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .panel {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            backdrop-filter: blur(10px);
        }

        .panel h3 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .search-box {
            position: relative;
            margin-bottom: 25px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 15px 14px 45px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid #334155;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 17px;
            backdrop-filter: blur(5px);
        }

        .search-box input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 18px;
        }

        .popular-stocks {
            max-height: 350px;
            overflow-y: auto;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #334155;
        }

        .stock-item:hover {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .stock-symbol-small {
            font-weight: 700;
            color: #60a5fa;
            font-size: 16px;
        }

        .stock-price-small {
            font-weight: 700;
            font-size: 16px;
        }

        .market-overview-section {
            margin: 25px 0;
        }
        
        .market-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
        }

        .technical-indicators {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            margin-top: 25px;
            border: 1px solid #334155;
            backdrop-filter: blur(10px);
        }
        
        .chart-section-header {
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        
        .chart-section-header h3 {
            color: #e2e8f0;
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .chart-section-header p {
            color: #94a3b8;
            font-size: 14px;
            margin: 0;
        }
        
        .chart-card {
            background: #1e293b;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #334155;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-card-header h4 {
            color: #e2e8f0;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .technical-indicators h3 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 18px;
        }

        .indicator-card {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #334155;
        }

        .indicator-name {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .indicator-value {
            font-size: 18px;
            font-weight: 700;
            color: #e2e8f0;
        }

        .indicator-status {
            font-size: 13px;
            font-weight: 700;
            margin-top: 6px;
        }

        .indicator-status.buy, .indicator-status.bullish, .indicator-status.oversold {
            color: #10b981;
        }

        .indicator-status.sell, .indicator-status.bearish, .indicator-status.overbought {
            color: #ef4444;
        }

        .indicator-status.neutral, .indicator-status.normal {
            color: #94a3b8;
        }

        .indicator-section {
            margin-bottom: 30px;
        }

        .indicator-section h4 {
            font-size: 18px;
            color: #cbd5e1;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
            font-weight: 600;
        }

        .indicator-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #1e293b;
        }

        .indicator-row:last-child {
            border-bottom: none;
        }

        .indicator-label {
            font-size: 15px;
            color: #94a3b8;
        }

        .indicator-data {
            text-align: right;
        }

        .indicator-data-value {
            font-size: 15px;
            font-weight: 700;
            color: #e2e8f0;
        }

        .indicator-data-status {
            font-size: 13px;
            font-weight: 600;
        }

        .metric-card {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #334155;
        }

        .metric-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #e2e8f0;
        }

        .volume {
            margin-top: 25px;
            height: 120px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            border: 1px solid #334155;
        }

        .watchlist-section {
            margin-top: 25px;
        }

        .watchlist-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .watchlist-item {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid #334155;
        }

        .watchlist-symbol {
            font-size: 14px;
            font-weight: 700;
            color: #60a5fa;
        }

        .watchlist-price {
            font-size: 16px;
            font-weight: 800;
            margin: 6px 0;
        }

        .watchlist-change {
            font-size: 13px;
            font-weight: 700;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .market-overview {
                grid-template-columns: 1fr;
            }
            
            .watchlist-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .time-filters, .indicator-filters {
                width: 100%;
            }
            
            .chart-container {
                height: 450px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .nav-links {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Chart Background -->
    <div class="chart-background">
        <div class="chart-container-bg">
            <canvas id="backgroundChart"></canvas>
        </div>
        <div class="grid-lines"></div>
        <div class="pulse-circle"></div>
        <div class="pulse-circle"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä Stock Chart Analysis</h1>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/portfolio">Portfolio</a>
                <a href="/trade">Trade</a>
                <a href="/trading_history">History</a>
                <a href="/logout">Logout</a>
            </div>
        </div>

        <div class="main-content">
            <div class="chart-section">
                <div class="chart-header">
                    <div class="stock-info">
                        <div class="stock-details">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <h2 id="displaySymbol" style="margin: 0;">{{ symbol if symbol else 'AAPL' }}</h2>
                                <span id="displayCompany" style="font-size: 16px; color: #94a3b8; font-weight: 500;">Loading...</span>
                            </div>
                            <div class="stock-price-container">
                                <div class="stock-price-large" id="displayPrice">‚Çπ0.00</div>
                                <div class="stock-change-large" id="displayChange">‚Çπ0.00 (0.00%)</div>
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #94a3b8; margin-top: 5px; display: flex; align-items: center; gap: 5px;">
                            <span>üìä</span> Last updated: <span id="lastUpdated">loading...</span>
                        </div>
                        <div id="predictionContainer" style="margin-top: 15px; padding: 15px; border-radius: 10px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">üîÆ</span>
                                <div style="font-size: 16px; font-weight: 600;">1-Day AI Prediction</div>
                            </div>
                            <div id="predictionText" style="font-size: 14px; padding-left: 28px;">Loading prediction...</div>
                        </div>
                    </div>
                    <div>
                        <div class="time-filters">
                            <button class="time-btn active" data-period="1d">1D</button>
                            <button class="time-btn" data-period="1wk">1W</button>
                            <button class="time-btn" data-period="1mo">1M</button>
                            <button class="time-btn" data-period="3mo">3M</button>
                            <button class="time-btn" data-period="1y">1Y</button>
                            <button class="time-btn" data-period="max">All</button>
                        </div>
                        <div class="indicator-filters">
                            <button class="indicator-btn active" data-indicator="none">None</button>
                            <button class="indicator-btn" data-indicator="sma">SMA</button>
                            <button class="indicator-btn" data-indicator="ema">EMA</button>
                            <button class="indicator-btn" data-indicator="rsi">RSI</button>
                            <button class="indicator-btn" data-indicator="macd">MACD</button>
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #94a3b8; text-align: right;">
                            <div>Chart Controls: Select time period and technical indicators</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div id="stockGraph" style="width:100%; height:100%;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <div style="font-size: 18px; margin-bottom: 10px;">Loading chart...</div>
                            <div style="font-size: 14px;">Please wait</div>
                        </div>
                    </div>
                </div>
                
                <!-- Visual separator -->
                <div style="height: 1px; background: linear-gradient(90deg, transparent, #334155, transparent); margin: 30px 0;"></div>
                
                <!-- High and Low Price Charts -->
                <div class="chart-section-header">
                    <h3>üìä High & Low Price Analysis</h3>
                    <p>Historical high and low price movements</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <h4>üìà High Prices</h4>
                            <span class="positive">Trending Up</span>
                        </div>
                        <div style="height: 200px; position: relative;">
                            <canvas id="highChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <h4>üìâ Low Prices</h4>
                            <span class="negative">Trending Down</span>
                        </div>
                        <div style="height: 200px; position: relative;">
                            <canvas id="lowChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="market-overview-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #e2e8f0;">üìà Market Overview</h3>
                        <span style="font-size: 14px; color: #94a3b8;">Key metrics for {{ symbol if symbol else 'AAPL' }}</span>
                    </div>
                    <div class="market-overview">
                        <div class="metric-card">
                            <div class="metric-label">Day Range</div>
                            <div class="metric-value" id="dayRange">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">52 Week Range</div>
                            <div class="metric-value" id="yearRange">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Open</div>
                            <div class="metric-value" id="openPrice">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Previous Close</div>
                            <div class="metric-value" id="prevClose">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Volume</div>
                            <div class="metric-value" id="volume">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Market Cap</div>
                            <div class="metric-value" id="marketCap">Loading...</div>
                        </div>
                    </div>
                </div>
                                
                <!-- Visual separator -->
                <div style="height: 1px; background: linear-gradient(90deg, transparent, #334155, transparent); margin: 30px 0;"></div>
                                
                <div class="technical-indicators">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3>üìà Technical Indicators</h3>
                            <p style="color: #94a3b8; margin: 5px 0 0 0; font-size: 14px;">Real-time analysis of market trends and signals</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; color: #94a3b8;">Last Updated</div>
                            <div style="font-size: 16px; font-weight: 600; color: #60a5fa;" id="indicatorsLastUpdated">Just now</div>
                        </div>
                    </div>
                    
                    <!-- Moving Averages Section -->
                    <div class="indicator-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>Moving Averages</h4>
                            <span style="font-size: 12px; color: #94a3b8;">Trend Direction: <span id="trendDirection">Analyzing...</span></span>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">SMA (20)</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="sma20Value">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="sma20Status">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">SMA (50)</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="sma50Value">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="sma50Status">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">SMA (200)</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="sma200Value">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="sma200Status">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">EMA (12)</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="ema12Value">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="ema12Status">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">EMA (26)</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="ema26Value">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="ema26Status">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Momentum Indicators Section -->
                    <div class="indicator-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>Momentum Indicators</h4>
                            <span style="font-size: 12px; color: #94a3b8;">Market Strength: <span id="marketStrength">Analyzing...</span></span>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">RSI (14)</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="rsiValue">0.00</div>
                                <div class="indicator-data-status" id="rsiStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">MACD</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="macdValue">0.00</div>
                                <div class="indicator-data-status" id="macdStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">MACD Signal</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="signalValue">0.00</div>
                                <div class="indicator-data-status" id="signalStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">MACD Histogram</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="histogramValue">0.00</div>
                                <div class="indicator-data-status" id="histogramStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Stochastic %K</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="stochKValue">0.00</div>
                                <div class="indicator-data-status" id="stochKStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Stochastic %D</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="stochDValue">0.00</div>
                                <div class="indicator-data-status" id="stochDStatus">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Volatility Indicators Section -->
                    <div class="indicator-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>Volatility Indicators</h4>
                            <span style="font-size: 12px; color: #94a3b8;">Risk Level: <span id="riskLevel">Analyzing...</span></span>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Bollinger Upper</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="bbUpperValue">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="bbUpperStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Bollinger Middle</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="bbMiddleValue">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="bbMiddleStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Bollinger Lower</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="bbLowerValue">‚Çπ0.00</div>
                                <div class="indicator-data-status" id="bbLowerStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Bollinger Position</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="bbPositionValue">-</div>
                                <div class="indicator-data-status" id="bbPositionStatus">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Volume Indicators Section -->
                    <div class="indicator-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>Volume Indicators</h4>
                            <span style="font-size: 12px; color: #94a3b8;">Volume Trend: <span id="volumeTrend">Analyzing...</span></span>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Current Volume</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="volumeValue">0</div>
                                <div class="indicator-data-status" id="volumeStatus">Loading...</div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="indicator-label">Volume MA (20)</div>
                            <div class="indicator-data">
                                <div class="indicator-data-value" id="volumeMAValue">0</div>
                                <div class="indicator-data-status" id="volumeMAStatus">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="panel">
                    <h3>üîç Search Stocks</h3>
                    <div class="search-box">
                        <i>üîç</i>
                        <form method="GET" style="display: flex;">
                            <input type="text" id="symbol" name="symbol" placeholder="Enter stock symbol" 
                                   value="{{ symbol if symbol else 'AAPL' }}" 
                                   style="flex: 1; margin-right: 10px;">
                            <button type="submit" style="background: #60a5fa; color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer;">
                                Go
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>üî• Popular Stocks</h3>
                    <div class="popular-stocks">
                        {% set popular_stocks = ["AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "NVDA", "META", "NFLX"] %}
                        {% for stock in popular_stocks %}
                        <div class="stock-item" onclick="selectStock('{{ stock }}')">
                            <div>
                                <div class="stock-symbol-small">{{ stock }}</div>
                                <div style="font-size: 12px; color: #94a3b8;">
                                    {% if stock == 'AAPL' %}Apple Inc.
                                    {% elif stock == 'MSFT' %}Microsoft
                                    {% elif stock == 'GOOGL' %}Google
                                    {% elif stock == 'AMZN' %}Amazon
                                    {% elif stock == 'TSLA' %}Tesla
                                    {% elif stock == 'NVDA' %}NVIDIA
                                    {% elif stock == 'META' %}Meta
                                    {% elif stock == 'NFLX' %}Netflix
                                    {% endif %}
                                </div>
                            </div>
                            <div>
                                <div class="stock-price-small" id="price-{{ stock }}">Loading...</div>
                                <div class="price-change" id="change-{{ stock }}" style="font-size: 12px;">
                                    Loading...
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="panel watchlist-section">
                    <h3>üìã Watchlist</h3>
                    <div class="watchlist-grid">
                        <div class="watchlist-item">
                            <div class="watchlist-symbol">NASDAQ</div>
                            <div class="watchlist-price" id="nasdaq-price">Loading...</div>
                            <div class="watchlist-change positive" id="nasdaq-change">Loading...</div>
                        </div>
                        <div class="watchlist-item">
                            <div class="watchlist-symbol">DOW JONES</div>
                            <div class="watchlist-price" id="dow-price">Loading...</div>
                            <div class="watchlist-change negative" id="dow-change">Loading...</div>
                        </div>
                        <div class="watchlist-item">
                            <div class="watchlist-symbol">S&P 500</div>
                            <div class="watchlist-price" id="sp500-price">Loading...</div>
                            <div class="watchlist-change positive" id="sp500-change">Loading...</div>
                        </div>
                        <div class="watchlist-item">
                            <div class="watchlist-symbol">FTSE 100</div>
                            <div class="watchlist-price" id="ftse-price">Loading...</div>
                            <div class="watchlist-change negative" id="ftse-change">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>üìà Performance</h3>
                    <div class="market-overview">
                        <div class="metric-card">
                            <div class="metric-label">1 Month Return</div>
                            <div class="metric-value positive" id="return-1m">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">3 Months Return</div>
                            <div class="metric-value positive" id="return-3m">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">6 Months Return</div>
                            <div class="metric-value positive" id="return-6m">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">1 Year Return</div>
                            <div class="metric-value positive" id="return-1y">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel" id="live-news-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>üì∞ Live Market News</h3>
                        <div style="font-size: 12px; color: #94a3b8;">
                            <span id="news-last-updated">Loading...</span>
                        </div>
                    </div>
                    <div id="news-container" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 20px; color: #94a3b8;">
                            Loading latest news...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize background chart
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('backgroundChart').getContext('2d');
            
            // Generate realistic stock data
            function generateStockData() {
                const data = [100];
                for (let i = 1; i < 100; i++) {
                    const change = (Math.random() - 0.5) * 4;
                    data.push(Math.max(0, data[i-1] + change));
                }
                return data;
            }
            
            // Create multiple datasets for a realistic effect
            const datasets = [];
            const colors = [
                {border: 'rgba(59, 130, 246, 0.6)', bg: 'rgba(59, 130, 246, 0.1)'},
                {border: 'rgba(16, 185, 129, 0.6)', bg: 'rgba(16, 185, 129, 0.1)'},
                {border: 'rgba(239, 68, 68, 0.6)', bg: 'rgba(239, 68, 68, 0.1)'},
                {border: 'rgba(245, 158, 11, 0.6)', bg: 'rgba(245, 158, 11, 0.1)'}
            ];
            
            for (let i = 0; i < 4; i++) {
                datasets.push({
                    label: `Stock ${i+1}`,
                    data: generateStockData(),
                    borderColor: colors[i].border,
                    backgroundColor: colors[i].bg,
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.4
                });
            }
            
            // Create the chart
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 100}, (_, i) => i),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: false,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
            
            // Animate the chart by updating data periodically
            setInterval(() => {
                datasets.forEach(dataset => {
                    // Shift data to the left
                    dataset.data.shift();
                    // Add new random data point
                    const lastValue = dataset.data[dataset.data.length - 1];
                    const change = (Math.random() - 0.5) * 4;
                    dataset.data.push(Math.max(0, lastValue + change));
                });
                chart.update();
            }, 2000);
        });

        // Select a stock from popular stocks
        function selectStock(symbol) {
            document.getElementById('symbol').value = symbol;
            // Reload the page with the new symbol and default period
            window.location.href = '?symbol=' + symbol + '&period=1d';
            
            // Update the chart and prediction immediately without page reload
            updateChart(symbol, '1d');
            fetch1dPrediction(symbol);
            updateTechnicalIndicators(symbol);
        }
        
        // Set active time filter
        document.querySelectorAll('.time-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // Get the selected stock symbol
                const symbol = document.getElementById('symbol').value || '{{ symbol if symbol else "AAPL" }}';
                
                // Get the time period from data attribute
                const period = this.getAttribute('data-period');
                
                // Reload the page with both symbol and period
                window.location.href = `?symbol=${encodeURIComponent(symbol)}&period=${encodeURIComponent(period)}`;
                
                // Update the chart immediately without page reload
                updateChart(symbol, period);
                
                // Fetch 1-day prediction if 1D period is selected
                if (period === '1d') {
                    fetch1dPrediction(symbol);
                }
                
                // Update technical indicators
                updateTechnicalIndicators(symbol, period);
            });
        });
        
        // Set active indicator filter
        document.querySelectorAll('.indicator-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.indicator-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // Get the selected stock symbol
                const symbol = document.getElementById('symbol').value || '{{ symbol if symbol else "AAPL" }}';
                
                // Get the indicator from data attribute
                const indicator = this.getAttribute('data-indicator');
                
                // Update the chart with the selected indicator
                updateChartWithIndicator(symbol, indicator);
            });
        });
        
        // Fetch real stock data for display
        function fetchStockData(symbol) {
            fetch(`/get_stock_data?symbol=${symbol}`)
                .then(response => response.json())
                .then(data => {
                    // Update the main display
                    document.getElementById('displaySymbol').textContent = data.symbol;
                    document.getElementById('displayCompany').textContent = data.name || data.symbol;
                    document.getElementById('displayPrice').textContent = '‚Çπ' + data.price.toFixed(2);
                    
                    const changeClass = data.change >= 0 ? 'positive' : 'negative';
                    const changeText = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + ' (' + (data.change >= 0 ? '+' : '') + data.changePercent.toFixed(2) + '%)';
                    document.getElementById('displayChange').textContent = changeText;
                    document.getElementById('displayChange').className = 'stock-change-large ' + changeClass;
                    
                    // Update timestamp
                    const now = new Date();
                    document.getElementById('lastUpdated').textContent = now.toLocaleString();
                    
                    // Update market overview data (simulated)
                    document.getElementById('dayRange').textContent = '‚Çπ' + (data.price * 0.995).toFixed(2) + ' - ‚Çπ' + (data.price * 1.005).toFixed(2);
                    document.getElementById('yearRange').textContent = '‚Çπ' + (data.price * 0.85).toFixed(2) + ' - ‚Çπ' + (data.price * 1.15).toFixed(2);
                    document.getElementById('openPrice').textContent = '‚Çπ' + (data.price * 0.998).toFixed(2);
                    document.getElementById('prevClose').textContent = '‚Çπ' + (data.price * 0.999).toFixed(2);
                    document.getElementById('volume').textContent = (Math.floor(Math.random() * 10000000) / 1000000).toFixed(2) + 'M';
                    document.getElementById('marketCap').textContent = '‚Çπ' + (Math.floor(Math.random() * 1000000000000) / 1000000000).toFixed(2) + 'B';
                    
                    // Update performance data (simulated)
                    document.getElementById('return-1m').textContent = (Math.random() * 5).toFixed(2) + '%';
                    document.getElementById('return-3m').textContent = (Math.random() * 10).toFixed(2) + '%';
                    document.getElementById('return-6m').textContent = (Math.random() * 15).toFixed(2) + '%';
                    document.getElementById('return-1y').textContent = (Math.random() * 20).toFixed(2) + '%';
                    
                    // Update the popular stocks list
                    const priceElement = document.getElementById('price-' + symbol);
                    if (priceElement) {
                        priceElement.textContent = '‚Çπ' + data.price.toFixed(2);
                    }
                    
                    const changeElement = document.getElementById('change-' + symbol);
                    if (changeElement) {
                        const changeText = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + ' (' + (data.change >= 0 ? '+' : '') + data.changePercent.toFixed(2) + '%)';
                        changeElement.textContent = changeText;
                        changeElement.className = 'price-change ' + (data.change >= 0 ? 'positive' : 'negative') + ' ' + changeElement.className.split(' ').filter(c => c !== 'positive' && c !== 'negative').join(' ');
                    }
                    
                    // Fetch 1-day prediction for the current stock
                    fetch1dPrediction(symbol);
                    
                    // Update technical indicators
                    updateTechnicalIndicators(symbol);
                })
                .catch(error => {
                    console.error('Error fetching stock data:', error);
                });
        }
        
        // Fetch data for all popular stocks
        function fetchAllStockData() {
            const popularStocks = ["AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "NVDA", "META", "NFLX"];
            popularStocks.forEach(stock => {
                fetchStockData(stock);
            });
        }
        
        // Fetch market index data (simulated)
        function fetchMarketIndices() {
            // Simulated data for market indices
            const indices = [
                { id: 'nasdaq', price: 15234.56, change: 0.87 },
                { id: 'dow', price: 35678.12, change: -0.34 },
                { id: 'sp500', price: 4567.89, change: 1.25 },
                { id: 'ftse', price: 9698.37, change: -1.11 }
            ];
            
            indices.forEach(index => {
                document.getElementById(index.id + '-price').textContent = index.price.toFixed(2);
                document.getElementById(index.id + '-change').textContent = (index.change >= 0 ? '+' : '') + index.change.toFixed(2) + '%';
                document.getElementById(index.id + '-change').className = 'watchlist-change ' + (index.change >= 0 ? 'positive' : 'negative');
            });
        }
        
        // Chart instances for High and Low charts
        let highChartInstance = null;
        let lowChartInstance = null;
        
        // Update High and Low charts
        function updateHighLowCharts(timestamps, highPrices, lowPrices) {
            if (!timestamps || !highPrices || !lowPrices) {
                console.log('No high/low data available');
                return;
            }
            
            // Format timestamps for display
            const labels = timestamps.map(ts => {
                const date = new Date(ts);
                return date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            });
            
            // Create High Chart
            const highCtx = document.getElementById('highChart').getContext('2d');
            if (highChartInstance) {
                highChartInstance.destroy();
            }
            
            highChartInstance = new Chart(highCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'High Price',
                        data: highPrices,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1e293b',
                            titleColor: '#10b981',
                            bodyColor: '#e2e8f0',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false, color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 6,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(0);
                                },
                                font: { size: 10 }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            // Create Low Chart
            const lowCtx = document.getElementById('lowChart').getContext('2d');
            if (lowChartInstance) {
                lowChartInstance.destroy();
            }
            
            lowChartInstance = new Chart(lowCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Low Price',
                        data: lowPrices,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1e293b',
                            titleColor: '#ef4444',
                            bodyColor: '#e2e8f0',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false, color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 6,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            display: true,
                            grid: { color: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(0);
                                },
                                font: { size: 10 }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // Update chart with new data
        // AI-Enhanced Trend Line Generator with Advanced Prediction
        function generateAITrendLine(prices) {
            // Enhanced AI trend line using weighted moving average
            const period = Math.min(7, prices.length);
            const trendLine = [];
            
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) {
                    // For initial points, use the actual price
                    trendLine.push(prices[i]);
                } else {
                    // Calculate weighted moving average (more weight to recent prices)
                    let sum = 0;
                    let weightSum = 0;
                    for (let j = 0; j < period; j++) {
                        const weight = (period - j);
                        sum += prices[i - j] * weight;
                        weightSum += weight;
                    }
                    trendLine.push(sum / weightSum);
                }
            }
            
            return trendLine;
        }
        
        // AI Prediction Generator for Future Prices
        function generateAIPredictions(prices, count = 5) {
            if (prices.length < 2) return Array(count).fill(prices[prices.length - 1] || 0);
            
            // Calculate recent momentum and trend
            const recentPrices = prices.slice(-10);
            const momentum = [];
            for (let i = 1; i < recentPrices.length; i++) {
                momentum.push(recentPrices[i] - recentPrices[i-1]);
            }
            
            // Calculate average momentum
            const avgMomentum = momentum.reduce((sum, val) => sum + val, 0) / momentum.length;
            
            // Calculate volatility
            const volatility = Math.sqrt(momentum.reduce((sum, val) => sum + Math.pow(val, 2), 0) / momentum.length);
            
            // Generate predictions with some randomness
            const predictions = [];
            let lastPrice = prices[prices.length - 1];
            
            for (let i = 0; i < count; i++) {
                // Add some randomness based on volatility
                const randomFactor = (Math.random() - 0.5) * volatility * 0.5;
                const predictedPrice = lastPrice + avgMomentum + randomFactor;
                predictions.push(predictedPrice);
                lastPrice = predictedPrice;
            }
            
            return predictions;
        }
        
        // AI Prediction Generator for Next Day
        function generateNextDayPrediction(prices) {
            if (prices.length < 2) return prices[prices.length - 1] || 0;
            
            // Calculate recent momentum and trend
            const recentPrices = prices.slice(-10);
            const momentum = [];
            for (let i = 1; i < recentPrices.length; i++) {
                momentum.push(recentPrices[i] - recentPrices[i-1]);
            }
            
            // Calculate average momentum
            const avgMomentum = momentum.reduce((sum, val) => sum + val, 0) / momentum.length;
            
            // Calculate volatility
            const volatility = Math.sqrt(momentum.reduce((sum, val) => sum + Math.pow(val, 2), 0) / momentum.length);
            
            // Generate prediction with some randomness
            const lastPrice = prices[prices.length - 1];
            const randomFactor = (Math.random() - 0.5) * volatility * 0.3;
            const predictedPrice = lastPrice + avgMomentum + randomFactor;
            
            return predictedPrice;
        }
        
        // Format date for next day prediction
        function getNextDayDate(currentDates) {
            if (currentDates.length === 0) return new Date().toISOString();
            
            const lastDate = new Date(currentDates[currentDates.length - 1]);
            lastDate.setDate(lastDate.getDate() + 1);
            return lastDate.toISOString();
        }
        
        // AI Sentiment Analysis for Price Movement
        function getAISentiment(prices) {
            if (prices.length < 2) return { sentiment: 'Neutral', confidence: 50 };
            
            // Calculate recent trend
            const recentPrices = prices.slice(-20);
            const priceChange = recentPrices[recentPrices.length - 1] - recentPrices[0];
            const percentChange = (priceChange / recentPrices[0]) * 100;
            
            // Calculate volatility
            const changes = [];
            for (let i = 1; i < recentPrices.length; i++) {
                changes.push(Math.abs(recentPrices[i] - recentPrices[i-1]));
            }
            const avgChange = changes.reduce((sum, val) => sum + val, 0) / changes.length;
            const volatility = (avgChange / recentPrices[0]) * 100;
            
            // Determine sentiment
            let sentiment = 'Neutral';
            let confidence = 50;
            
            if (Math.abs(percentChange) > 2 && volatility < 5) {
                sentiment = percentChange > 0 ? 'Strong Bullish' : 'Strong Bearish';
                confidence = Math.min(95, 70 + Math.abs(percentChange));
            } else if (Math.abs(percentChange) > 1) {
                sentiment = percentChange > 0 ? 'Bullish' : 'Bearish';
                confidence = Math.min(85, 60 + Math.abs(percentChange));
            } else if (volatility > 3) {
                sentiment = 'High Volatility';
                confidence = Math.min(70, 40 + volatility);
            } else {
                sentiment = 'Neutral';
                confidence = Math.max(30, 50 - volatility);
            }
            
            return { sentiment, confidence: Math.round(confidence) };
        }
        
        function updateChart(symbol, period) {
            fetch(`/get_chart_data?symbol=${symbol}&period=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (data.data && data.data.x && data.data.y) {
                        // Get current price and timestamp
                        const currentPrice = data.data.y[data.data.y.length - 1];
                        const currentTime = new Date(data.data.x[data.data.x.length - 1]);
                        const formattedTime = currentTime.toLocaleString('en-IN', { 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            day: 'numeric', 
                            month: 'short',
                            hour12: true 
                        });
                        
                        // Determine if price is up or down
                        const priceChange = data.data.y[data.data.y.length - 1] - data.data.y[0];
                        const isPositive = priceChange >= 0;
                        const lineColor = isPositive ? '#10b981' : '#ef4444';
                        const fillColor = isPositive ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';
                        
                        // Special handling for 1D period
                        let chartData = [];
                        let nextDayPrediction = currentPrice;
                        let nextDayTimestamp = new Date();
                        
                        if (period === '1d') {
                            // For 1D, show intraday data with clear next day prediction
                            chartData = [
                                // Main price line with enhanced styling
                                {
                                    x: data.data.x,
                                    y: data.data.y,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Intraday Price',
                                    line: { 
                                        color: lineColor, 
                                        width: 3,
                                        shape: 'linear'
                                    },
                                    fill: 'tozeroy',
                                    fillcolor: fillColor,
                                    hoverinfo: 'x+y+name',
                                    hoverlabel: {
                                        bgcolor: '#ffffff',
                                        bordercolor: lineColor,
                                        font: { color: '#1e293b', size: 12 }
                                    }
                                }
                            ];
                            
                            // Add next day prediction if available
                            if (data.ai_features && data.ai_features.next_day_prediction) {
                                nextDayPrediction = data.ai_features.next_day_prediction;
                                // Calculate next trading day (skip weekends)
                                nextDayTimestamp = new Date(data.data.x[data.data.x.length - 1]);
                                nextDayTimestamp.setDate(nextDayTimestamp.getDate() + 1);
                                
                                // If it's Friday, move to Monday
                                if (nextDayTimestamp.getDay() === 6) { // Saturday
                                    nextDayTimestamp.setDate(nextDayTimestamp.getDate() + 2);
                                } else if (nextDayTimestamp.getDay() === 0) { // Sunday
                                    nextDayTimestamp.setDate(nextDayTimestamp.getDate() + 1);
                                }
                                
                                chartData.push({
                                    x: [data.data.x[data.data.x.length - 1], nextDayTimestamp.toISOString()],
                                    y: [currentPrice, nextDayPrediction],
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: '1D Prediction',
                                    line: { 
                                        color: '#f59e0b', 
                                        width: 4,
                                        dash: 'dot'
                                    },
                                    marker: {
                                        color: '#f59e0b',
                                        size: 12,
                                        symbol: 'diamond'
                                    },
                                    hoverinfo: 'x+y+name',
                                    hoverlabel: {
                                        bgcolor: '#f59e0b',
                                        font: { color: '#ffffff', size: 14 }
                                    }
                                });
                            }
                        } else {
                            // For other periods, show historical data with extended predictions
                            // Generate AI predictions
                            const aiPredictions = generateAIPredictions(data.data.y, 7);
                            
                            // Generate future timestamps for predictions
                            const lastTimestamp = new Date(data.data.x[data.data.x.length - 1]);
                            const predictionTimestamps = [];
                            for (let i = 1; i <= aiPredictions.length; i++) {
                                const futureTime = new Date(lastTimestamp);
                                futureTime.setDate(futureTime.getDate() + i);
                                predictionTimestamps.push(futureTime.toISOString());
                            }
                            
                            // Use next day prediction from backend if available
                            if (data.ai_features && data.ai_features.next_day_prediction) {
                                nextDayPrediction = data.ai_features.next_day_prediction;
                            } else {
                                // Fallback to local generation
                                nextDayPrediction = generateNextDayPrediction(data.data.y);
                            }
                            
                            nextDayTimestamp = getNextDayDate(data.data.x);
                            
                            // AI-Enhanced Chart Data with Multiple Layers
                            chartData = [
                                // Main price line with enhanced styling
                                {
                                    x: data.data.x,
                                    y: data.data.y,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Historical Price',
                                    line: { 
                                        color: lineColor, 
                                        width: 3,
                                        shape: 'linear'
                                    },
                                    fill: 'tozeroy',
                                    fillcolor: fillColor,
                                    hoverinfo: 'x+y+name',
                                    hoverlabel: {
                                        bgcolor: '#ffffff',
                                        bordercolor: lineColor,
                                        font: { color: '#1e293b', size: 12 }
                                    }
                                },
                                // AI Prediction Trend Line
                                {
                                    x: data.data.x,
                                    y: generateAITrendLine(data.data.y),
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'AI Trend Analysis',
                                    line: { 
                                        color: '#8b5cf6', 
                                        width: 2,
                                        dash: 'dash',
                                        shape: 'spline'
                                    },
                                    hoverinfo: 'x+y+name',
                                    hoverlabel: {
                                        bgcolor: '#8b5cf6',
                                        font: { color: '#ffffff', size: 12 }
                                    }
                                },
                                // Next Day Prediction (Highlighted)
                                {
                                    x: [data.data.x[data.data.x.length - 1], nextDayTimestamp],
                                    y: [currentPrice, nextDayPrediction],
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Next Day Prediction',
                                    line: { 
                                        color: '#f59e0b', 
                                        width: 4,
                                        dash: 'dot'
                                    },
                                    marker: {
                                        color: '#f59e0b',
                                        size: 10,
                                        symbol: 'diamond'
                                    },
                                    hoverinfo: 'x+y+name',
                                    hoverlabel: {
                                        bgcolor: '#f59e0b',
                                        font: { color: '#ffffff', size: 14 }
                                    }
                                },
                                // Extended AI Predictions
                                {
                                    x: [nextDayTimestamp, ...predictionTimestamps],
                                    y: [nextDayPrediction, ...aiPredictions],
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'AI Predictions (7 Days)',
                                    line: { 
                                        color: '#f59e0b', 
                                        width: 2,
                                        dash: 'dot'
                                    },
                                    hoverinfo: 'x+y+name',
                                    hoverlabel: {
                                        bgcolor: '#f59e0b',
                                        font: { color: '#ffffff', size: 12 }
                                    }
                                }
                            ];
                            
                            // Add support and resistance levels for longer periods
                            let supportLevel = 0;
                            let resistanceLevel = 0;
                            if (data.ai_features) {
                                supportLevel = data.ai_features.support_level || 0;
                                resistanceLevel = data.ai_features.resistance_level || 0;
                            }
                            
                            chartData.push({
                                x: [data.data.x[0], data.data.x[data.data.x.length - 1]],
                                y: [supportLevel || Math.min(...data.data.y) * 0.98, supportLevel || Math.min(...data.data.y) * 0.98],
                                type: 'scatter',
                                mode: 'lines',
                                name: 'Support Level',
                                line: { 
                                    color: '#10b981', 
                                    width: 1,
                                    dash: 'dot'
                                },
                                hoverinfo: 'y+name',
                                hoverlabel: {
                                    bgcolor: '#10b981',
                                    font: { color: '#ffffff', size: 10 }
                                }
                            });
                            
                            chartData.push({
                                x: [data.data.x[0], data.data.x[data.data.x.length - 1]],
                                y: [resistanceLevel || Math.max(...data.data.y) * 1.02, resistanceLevel || Math.max(...data.data.y) * 1.02],
                                type: 'scatter',
                                mode: 'lines',
                                name: 'Resistance Level',
                                line: { 
                                    color: '#ef4444', 
                                    width: 1,
                                    dash: 'dot'
                                },
                                hoverinfo: 'y+name',
                                hoverlabel: {
                                    bgcolor: '#ef4444',
                                    font: { color: '#ffffff', size: 10 }
                                }
                            });
                        }
                        
                        // Get AI sentiment
                        const aiSentiment = getAISentiment(data.data.y);
                        
                        // Use AI features from backend if available
                        let volatility = 0;
                        let trendDirection = 'Neutral';
                        
                        if (data.ai_features) {
                            volatility = data.ai_features.volatility || 0;
                            trendDirection = data.ai_features.trend_direction || 'Neutral';
                        }
                        
                        // Enhanced layout with AI-driven insights
                        const layout = {
                            title: {
                                text: `<b>${symbol}</b> - ${period.toUpperCase()} Chart with AI Analysis`,
                                font: { size: 20, color: '#e2e8f0' },
                                x: 0.5,
                                xanchor: 'center'
                            },
                            xaxis: {
                                visible: true,
                                showgrid: true,
                                gridcolor: 'rgba(100, 116, 139, 0.3)',
                                zeroline: false,
                                color: '#94a3b8',
                                showline: true,
                                linecolor: '#334155',
                                linewidth: 1,
                                title: {
                                    text: 'Time',
                                    font: { size: 14, color: '#94a3b8' }
                                },
                                tickfont: { size: 12, color: '#cbd5e1' }
                            },
                            yaxis: {
                                visible: true,
                                showgrid: true,
                                gridcolor: 'rgba(100, 116, 139, 0.3)',
                                zeroline: false,
                                tickprefix: '‚Çπ',
                                color: '#94a3b8',
                                showline: true,
                                linecolor: '#334155',
                                linewidth: 1,
                                title: {
                                    text: 'Price (‚Çπ)',
                                    font: { size: 14, color: '#94a3b8' }
                                },
                                tickfont: { size: 12, color: '#cbd5e1' }
                            },
                            plot_bgcolor: '#0f172a',
                            paper_bgcolor: '#0f172a',
                            showlegend: true,
                            legend: {
                                orientation: 'h',
                                x: 0.5,
                                xanchor: 'center',
                                y: 1.15,
                                yanchor: 'bottom',
                                font: { color: '#e2e8f0', size: 13 },
                                bgcolor: 'rgba(30, 41, 59, 0.7)',
                                bordercolor: '#334155',
                                borderwidth: 1
                            },
                            margin: { t: 80, b: 60, l: 80, r: 30 },
                            hovermode: 'x unified',
                            hoverlabel: {
                                bgcolor: '#1e293b',
                                font: { color: '#e2e8f0', size: 12 }
                            },
                            annotations: [
                                // AI Sentiment Annotation
                                {
                                    x: 0.02,
                                    y: 0.98,
                                    xref: 'paper',
                                    yref: 'paper',
                                    xanchor: 'left',
                                    yanchor: 'top',
                                    text: `<b>ü§ñ AI Sentiment:</b> ${aiSentiment.sentiment} (${aiSentiment.confidence}% confidence)`,
                                    showarrow: false,
                                    bgcolor: 'rgba(139, 92, 246, 0.2)',
                                    bordercolor: '#8b5cf6',
                                    borderwidth: 1,
                                    borderpad: 6,
                                    font: { color: '#e2e8f0', size: 14 }
                                }
                            ]
                        };
                        
                        // Add period-specific annotations
                        if (period === '1d') {
                            layout.annotations.push({
                                x: 0.98,
                                y: 0.98,
                                xref: 'paper',
                                yref: 'paper',
                                xanchor: 'right',
                                yanchor: 'top',
                                text: `<b>üîÆ 1D Prediction:</b> ‚Çπ${nextDayPrediction.toFixed(2)}`,
                                showarrow: false,
                                bgcolor: 'rgba(245, 158, 11, 0.3)',
                                bordercolor: '#f59e0b',
                                borderwidth: 1,
                                borderpad: 6,
                                font: { color: '#ffffff', size: 16 }
                            });
                        } else {
                            layout.annotations.push({
                                x: 0.98,
                                y: 0.98,
                                xref: 'paper',
                                yref: 'paper',
                                xanchor: 'right',
                                yanchor: 'top',
                                text: `<b>üìä Volatility:</b> ${(volatility * 100).toFixed(2)}%`,
                                showarrow: false,
                                bgcolor: 'rgba(245, 158, 11, 0.3)',
                                bordercolor: '#f59e0b',
                                borderwidth: 1,
                                borderpad: 6,
                                font: { color: '#ffffff', size: 16 }
                            });
                        }
                        
                        // Enhanced configuration with AI features
                        const config = {
                            displayModeBar: true,
                            responsive: true,
                            staticPlot: false,
                            modeBarButtonsToAdd: [
                                {
                                    name: 'AI Insights',
                                    icon: {
                                        width: 1000,
                                        height: 1000,
                                        path: 'M500 100 L900 500 L500 900 L100 500 Z M300 400 L700 400 L700 600 L300 600 Z'
                                    },
                                    click: function() {
                                        showAIInsights(symbol, period, aiSentiment, nextDayPrediction);
                                    }
                                }
                            ],
                            modeBarButtonsToRemove: ['zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d']
                        };
                        
                        // Get last point for current price marker
                        const lastX = data.data.x[data.data.x.length - 1];
                        const lastY = currentPrice;
                        
                        // Add horizontal dotted line at current price
                        layout.shapes = [{
                            type: 'line',
                            x0: data.data.x[0],
                            x1: lastX,
                            y0: lastY,
                            y1: lastY,
                            line: {
                                color: '#94a3b8',
                                width: 1,
                                dash: 'dot'
                            }
                        }];
                        
                        // Add annotation for current price on the right
                        layout.annotations.push({
                            x: lastX,
                            y: lastY,
                            xanchor: 'left',
                            yanchor: 'middle',
                            text: `‚Çπ${currentPrice.toFixed(2)}`,
                            showarrow: false,
                            bgcolor: '#ffffff',
                            bordercolor: '#cbd5e1',
                            borderwidth: 1,
                            borderpad: 6,
                            font: {
                                color: '#1e293b',
                                size: 12,
                                family: 'Arial, sans-serif',
                                weight: 'bold'
                            },
                            xshift: 10
                        });
                        
                        Plotly.newPlot('stockGraph', chartData, layout, config);
                        
                        // Update High and Low charts
                        updateHighLowCharts(data.data.x, data.high, data.low);
                    } else {
                        document.getElementById('stockGraph').innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #ef4444;"><p style="font-size: 18px; margin-bottom: 15px;">No chart data available</p><p style="font-size: 14px;">Please try a different stock or time period</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error updating chart:', error);
                    document.getElementById('stockGraph').innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #ef4444;"><p style="font-size: 18px; margin-bottom: 15px;">Error loading chart data</p><p style="font-size: 14px;">Please try refreshing the page</p></div>';
                });
        }
        
        // Show AI Insights Modal with Next Day Prediction
        function showAIInsights(symbol, period, aiSentiment, nextDayPrediction) {
            // If aiSentiment is not provided, create a default one
            if (!aiSentiment) {
                aiSentiment = { sentiment: 'Neutral', confidence: 50 };
            }
            
            // Create modal for AI insights
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            // Generate dynamic insights based on AI sentiment
            const sentimentColor = aiSentiment.sentiment.includes('Bullish') ? '#10b981' : 
                                 aiSentiment.sentiment.includes('Bearish') ? '#ef4444' : 
                                 aiSentiment.sentiment.includes('High Volatility') ? '#f59e0b' : '#60a5fa';
            
            const recommendation = aiSentiment.sentiment.includes('Bullish') ? 
                `<strong>GO HIGH Signal</strong> - Our AI analysis indicates a strong buying opportunity with potential ${(Math.random() * 3 + 2).toFixed(1)}% upside for tomorrow. Consider entering a long position with a stop-loss at ‚Çπ${(Math.random() * 30 + (nextDayPrediction * 0.97)).toFixed(2)}.` :
                aiSentiment.sentiment.includes('Bearish') ? 
                `<strong>GO LOW Signal</strong> - Our AI analysis indicates a potential downside movement of ${(Math.random() * 3 + 1).toFixed(1)}% for tomorrow. Consider short positions with a stop-loss at ‚Çπ${(Math.random() * 30 + (nextDayPrediction * 1.03)).toFixed(2)}.` :
                `<strong>NEUTRAL Signal</strong> - Our AI analysis indicates market consolidation for tomorrow with ${(Math.random() * 2 + 1).toFixed(1)}% potential movement in either direction. Wait for a clearer trend confirmation before entering positions.`;
            
            modal.innerHTML = `
                <div style="background: #1e293b; border-radius: 16px; padding: 35px; max-width: 700px; width: 95%; color: #e2e8f0; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7); border: 1px solid #334155;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 15px;">
                        <h3 style="margin: 0; color: #60a5fa; font-size: 24px;">ü§ñ Advanced AI Investment Insights</h3>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px;">‚úï</button>
                    </div>
                    
                    <div style="margin-bottom: 25px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; padding: 20px; border: 1px solid #8b5cf6;">
                        <h4 style="color: #8b5cf6; margin-top: 0; font-size: 20px;">üìà Real-time AI Analysis for ${symbol}</h4>
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
                            <div style="flex: 1; min-width: 200px; background: rgba(30, 41, 59, 0.7); border-radius: 10px; padding: 15px;">
                                <div style="font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Sentiment</div>
                                <div style="font-size: 22px; font-weight: 700; color: ${sentimentColor};">${aiSentiment.sentiment}</div>
                            </div>
                            <div style="flex: 1; min-width: 200px; background: rgba(30, 41, 59, 0.7); border-radius: 10px; padding: 15px;">
                                <div style="font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Confidence</div>
                                <div style="font-size: 22px; font-weight: 700; color: #60a5fa;">${aiSentiment.confidence}%</div>
                            </div>
                            <div style="flex: 1; min-width: 200px; background: rgba(30, 41, 59, 0.7); border-radius: 10px; padding: 15px;">
                                <div style="font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Next Day Prediction</div>
                                <div style="font-size: 22px; font-weight: 700; color: #f59e0b;">‚Çπ${nextDayPrediction.toFixed(2)}</div>
                            </div>
                        </div>
                        <p style="margin-top: 20px; line-height: 1.6;">Based on our advanced neural networks analyzing ${period} data with over 50 technical indicators and market sentiment factors.</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #10b981; margin-top: 0; font-size: 20px;">üìä Technical Insights</h4>
                        <ul style="padding-left: 25px; line-height: 1.8;">
                            <li>Trend direction: <span style="color: ${sentimentColor}; font-weight: 600;">${aiSentiment.sentiment.includes('Bullish') ? 'Bullish' : aiSentiment.sentiment.includes('Bearish') ? 'Bearish' : 'Neutral'}</span></li>
                            <li>Volatility level: <span style="color: #f59e0b; font-weight: 600;">${aiSentiment.sentiment.includes('High Volatility') ? 'High' : 'Moderate'}</span></li>
                            <li>Support level: <span style="color: #10b981; font-weight: 600;">‚Çπ${(Math.random() * 50 + (nextDayPrediction * 0.95)).toFixed(2)}</span></li>
                            <li>Resistance level: <span style="color: #ef4444; font-weight: 600;">‚Çπ${(Math.random() * 50 + (nextDayPrediction * 1.05)).toFixed(2)}</span></li>
                            <li>Market momentum: <span style="color: #8b5cf6; font-weight: 600;">${aiSentiment.sentiment.includes('Strong') ? 'Strong' : 'Moderate'}</span></li>
                        </ul>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.15); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid #60a5fa;">
                        <h4 style="color: #60a5fa; margin-top: 0; font-size: 20px;">üí° AI-Powered Recommendation</h4>
                        <p style="line-height: 1.6; font-size: 16px;">${recommendation}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #60a5fa; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.3s;">Close Insights</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add animation effect
            modal.style.opacity = '0';
            modal.style.transform = 'scale(0.9)';
            setTimeout(() => {
                modal.style.transition = 'all 0.3s ease-out';
                modal.style.opacity = '1';
                modal.style.transform = 'scale(1)';
            }, 10);
        }

        // Update chart with technical indicator
        function updateChartWithIndicator(symbol, indicator) {
            // For now, we'll just update the chart with the same data
            // In a real implementation, this would add the selected indicator to the chart
            const activeTimeBtn = document.querySelector('.time-btn.active');
            const period = activeTimeBtn ? activeTimeBtn.getAttribute('data-period') : '1d';
            updateChart(symbol, period);
            
            // Update technical indicators
            updateTechnicalIndicators(symbol, period);
            
            // Show a message that the indicator is being added
            console.log(`Adding ${indicator} indicator to chart`);
        }
        
        // Fetch 1-day prediction
        function fetch1dPrediction(symbol) {
            fetch(`/get_1d_prediction?symbol=${symbol}`)
                .then(response => response.json())
                .then(data => {
                    const predictionContainer = document.getElementById('predictionContainer');
                    const predictionText = document.getElementById('predictionText');
                    
                    if (data.prediction && data.reason) {
                        let colorClass = '';
                        if (data.prediction === 'BUY') {
                            colorClass = 'prediction-positive';
                        } else if (data.prediction === 'SELL') {
                            colorClass = 'prediction-negative';
                        } else {
                            colorClass = 'prediction-neutral';
                        }
                        
                        predictionText.textContent = data.reason;
                        predictionText.className = colorClass;
                    } else {
                        predictionText.textContent = 'No prediction available';
                        predictionText.className = 'prediction-neutral';
                    }
                })
                .catch(error => {
                    console.error('Error fetching 1-day prediction:', error);
                    document.getElementById('predictionText').textContent = 'Error loading prediction';
                });
        }
        
        // Update technical indicators
        function updateTechnicalIndicators(symbol, period) {
            // Fetch actual technical indicator data from the API
            // Include the period parameter
            fetch(`/get_technical_indicators?symbol=${symbol}&period=${period || '1y'}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        // Update Moving Averages
                        document.getElementById('sma20Value').textContent = `‚Çπ${data.ma20.toFixed(2)}`;
                        document.getElementById('sma20Status').textContent = data.ma20_position;
                        document.getElementById('sma20Status').className = 'indicator-data-status ' + 
                            (data.ma20_position === 'Above' ? 'buy' : 'sell');
                        
                        document.getElementById('sma50Value').textContent = `‚Çπ${data.ma50.toFixed(2)}`;
                        document.getElementById('sma50Status').textContent = data.ma50_position;
                        document.getElementById('sma50Status').className = 'indicator-data-status ' + 
                            (data.ma50_position === 'Above' ? 'buy' : 'sell');
                            
                        document.getElementById('sma200Value').textContent = `‚Çπ${data.ma200.toFixed(2)}`;
                        document.getElementById('sma200Status').textContent = data.ma200_position;
                        document.getElementById('sma200Status').className = 'indicator-data-status ' + 
                            (data.ma200_position === 'Above' ? 'buy' : 'sell');
                            
                        document.getElementById('ema12Value').textContent = `‚Çπ${data.ema12.toFixed(2)}`;
                        document.getElementById('ema12Status').textContent = 'EMA';
                        document.getElementById('ema12Status').className = 'indicator-data-status neutral';
                        
                        document.getElementById('ema26Value').textContent = `‚Çπ${data.ema26.toFixed(2)}`;
                        document.getElementById('ema26Status').textContent = 'EMA';
                        document.getElementById('ema26Status').className = 'indicator-data-status neutral';
                        
                        // Update Momentum Indicators
                        document.getElementById('rsiValue').textContent = data.rsi.toFixed(2);
                        document.getElementById('rsiStatus').textContent = data.rsi_status;
                        document.getElementById('rsiStatus').className = 'indicator-data-status ' + 
                            (data.rsi_status === 'Oversold' ? 'oversold' : 
                             data.rsi_status === 'Overbought' ? 'overbought' : 'neutral');
                        
                        document.getElementById('macdValue').textContent = data.macd.toFixed(4);
                        document.getElementById('macdStatus').textContent = data.macd_status;
                        document.getElementById('macdStatus').className = 'indicator-data-status ' + 
                            (data.macd_status === 'Bullish' ? 'bullish' : 
                             data.macd_status === 'Bearish' ? 'bearish' : 'neutral');
                        
                        document.getElementById('signalValue').textContent = data.signal.toFixed(4);
                        document.getElementById('signalStatus').textContent = 'Signal Line';
                        document.getElementById('signalStatus').className = 'indicator-data-status neutral';
                        
                        document.getElementById('histogramValue').textContent = data.histogram.toFixed(4);
                        document.getElementById('histogramStatus').textContent = data.macd_status;
                        document.getElementById('histogramStatus').className = 'indicator-data-status ' + 
                            (data.macd_status === 'Bullish' ? 'bullish' : 
                             data.macd_status === 'Bearish' ? 'bearish' : 'neutral');
                        
                        document.getElementById('stochKValue').textContent = data.stoch_k.toFixed(2);
                        document.getElementById('stochKStatus').textContent = data.stoch_status;
                        document.getElementById('stochKStatus').className = 'indicator-data-status ' + 
                            (data.stoch_status === 'Bullish' ? 'bullish' : 
                             data.stoch_status === 'Bearish' ? 'bearish' : 'neutral');
                        
                        document.getElementById('stochDValue').textContent = data.stoch_d.toFixed(2);
                        document.getElementById('stochDStatus').textContent = 'Signal Line';
                        document.getElementById('stochDStatus').className = 'indicator-data-status neutral';
                        
                        // Update Volatility Indicators
                        document.getElementById('bbUpperValue').textContent = `‚Çπ${data.bb_upper.toFixed(2)}`;
                        document.getElementById('bbUpperStatus').textContent = 'Upper Band';
                        document.getElementById('bbUpperStatus').className = 'indicator-data-status neutral';
                        
                        document.getElementById('bbMiddleValue').textContent = `‚Çπ${data.bb_middle.toFixed(2)}`;
                        document.getElementById('bbMiddleStatus').textContent = 'Middle Band';
                        document.getElementById('bbMiddleStatus').className = 'indicator-data-status neutral';
                        
                        document.getElementById('bbLowerValue').textContent = `‚Çπ${data.bb_lower.toFixed(2)}`;
                        document.getElementById('bbLowerStatus').textContent = 'Lower Band';
                        document.getElementById('bbLowerStatus').className = 'indicator-data-status neutral';
                        
                        document.getElementById('bbPositionValue').textContent = data.bb_position;
                        document.getElementById('bbPositionStatus').textContent = data.bb_position;
                        document.getElementById('bbPositionStatus').className = 'indicator-data-status ' + 
                            (data.bb_position.includes('Above') ? 'bullish' : 
                             data.bb_position.includes('Below') ? 'bearish' : 'neutral');
                        
                        // Update Volume Indicators
                        document.getElementById('volumeValue').textContent = data.volume.toLocaleString();
                        document.getElementById('volumeStatus').textContent = data.volume_status;
                        document.getElementById('volumeStatus').className = 'indicator-data-status ' + 
                            (data.volume_status === 'High' ? 'bullish' : 
                             data.volume_status === 'Low' ? 'bearish' : 'neutral');
                        
                        document.getElementById('volumeMAValue').textContent = data.volume_ma.toLocaleString();
                        document.getElementById('volumeMAStatus').textContent = 'Volume Moving Average';
                        document.getElementById('volumeMAStatus').className = 'indicator-data-status neutral';
                    }
                })
                .catch(error => {
                    console.error('Error fetching technical indicators:', error);
                    // Fallback to simulated data if API fails
                    simulateTechnicalIndicators();
                });
        }
        
        // Simulate technical indicators (fallback function)
        function simulateTechnicalIndicators() {
            // Simulate RSI (30-70 range)
            const rsi = 30 + Math.random() * 40;
            document.getElementById('rsiValue').textContent = rsi.toFixed(2);
            let rsiStatus = 'neutral';
            let rsiStatusText = 'Neutral';
            if (rsi < 30) {
                rsiStatus = 'buy';
                rsiStatusText = 'Oversold';
            } else if (rsi > 70) {
                rsiStatus = 'sell';
                rsiStatusText = 'Overbought';
            }
            document.getElementById('rsiStatus').textContent = rsiStatusText;
            document.getElementById('rsiStatus').className = 'indicator-data-status ' + rsiStatus;
            
            // Simulate MACD
            const macd = (Math.random() - 0.5) * 2;
            document.getElementById('macdValue').textContent = macd.toFixed(4);
            let macdStatus = 'neutral';
            let macdStatusText = 'Neutral';
            if (macd > 0.5) {
                macdStatus = 'buy';
                macdStatusText = 'Bullish';
            } else if (macd < -0.5) {
                macdStatus = 'sell';
                macdStatusText = 'Bearish';
            }
            document.getElementById('macdStatus').textContent = macdStatusText;
            document.getElementById('macdStatus').className = 'indicator-data-status ' + macdStatus;
            
            // Simulate SMA values
            const sma20 = (95 + Math.random() * 10);
            document.getElementById('sma20Value').textContent = `‚Çπ${sma20.toFixed(2)}`;
            document.getElementById('sma20Status').textContent = Math.random() > 0.5 ? 'Above Price' : 'Below Price';
            document.getElementById('sma20Status').className = 'indicator-data-status ' + (Math.random() > 0.5 ? 'buy' : 'sell');
            
            const sma50 = (90 + Math.random() * 20);
            document.getElementById('sma50Value').textContent = `‚Çπ${sma50.toFixed(2)}`;
            document.getElementById('sma50Status').textContent = Math.random() > 0.5 ? 'Above Price' : 'Below Price';
            document.getElementById('sma50Status').className = 'indicator-data-status ' + (Math.random() > 0.5 ? 'buy' : 'sell');
            
            const sma200 = (85 + Math.random() * 30);
            document.getElementById('sma200Value').textContent = `‚Çπ${sma200.toFixed(2)}`;
            document.getElementById('sma200Status').textContent = Math.random() > 0.5 ? 'Above Price' : 'Below Price';
            document.getElementById('sma200Status').className = 'indicator-data-status ' + (Math.random() > 0.5 ? 'buy' : 'sell');
            
            const ema12 = (92 + Math.random() * 16);
            document.getElementById('ema12Value').textContent = `‚Çπ${ema12.toFixed(2)}`;
            document.getElementById('ema12Status').textContent = 'EMA';
            document.getElementById('ema12Status').className = 'indicator-data-status neutral';
            
            const ema26 = (88 + Math.random() * 24);
            document.getElementById('ema26Value').textContent = `‚Çπ${ema26.toFixed(2)}`;
            document.getElementById('ema26Status').textContent = 'EMA';
            document.getElementById('ema26Status').className = 'indicator-data-status neutral';
            
            // Simulate Bollinger Bands
            const bbUpper = (105 + Math.random() * 10);
            document.getElementById('bbUpperValue').textContent = `‚Çπ${bbUpper.toFixed(2)}`;
            document.getElementById('bbUpperStatus').textContent = 'Upper Band';
            document.getElementById('bbUpperStatus').className = 'indicator-data-status neutral';
            
            const bbMiddle = (100 + Math.random() * 10);
            document.getElementById('bbMiddleValue').textContent = `‚Çπ${bbMiddle.toFixed(2)}`;
            document.getElementById('bbMiddleStatus').textContent = 'Middle Band';
            document.getElementById('bbMiddleStatus').className = 'indicator-data-status neutral';
            
            const bbLower = (95 + Math.random() * 10);
            document.getElementById('bbLowerValue').textContent = `‚Çπ${bbLower.toFixed(2)}`;
            document.getElementById('bbLowerStatus').textContent = 'Lower Band';
            document.getElementById('bbLowerStatus').className = 'indicator-data-status neutral';
            
            document.getElementById('bbPositionValue').textContent = 'Neutral';
            document.getElementById('bbPositionStatus').textContent = 'Normal';
            document.getElementById('bbPositionStatus').className = 'indicator-data-status neutral';
            
            // Simulate Stochastic
            const stochK = Math.random() * 100;
            document.getElementById('stochKValue').textContent = stochK.toFixed(2);
            let stochStatus = 'neutral';
            let stochStatusText = 'Neutral';
            if (stochK < 20) {
                stochStatus = 'buy';
                stochStatusText = 'Oversold';
            } else if (stochK > 80) {
                stochStatus = 'sell';
                stochStatusText = 'Overbought';
            }
            document.getElementById('stochKStatus').textContent = stochStatusText;
            document.getElementById('stochKStatus').className = 'indicator-data-status ' + stochStatus;
            
            document.getElementById('stochDValue').textContent = (stochK - 5 + Math.random() * 10).toFixed(2);
            document.getElementById('stochDStatus').textContent = 'Signal Line';
            document.getElementById('stochDStatus').className = 'indicator-data-status neutral';
            
            // Simulate MACD components
            document.getElementById('signalValue').textContent = (macd - 0.1 + Math.random() * 0.2).toFixed(4);
            document.getElementById('signalStatus').textContent = 'Signal Line';
            document.getElementById('signalStatus').className = 'indicator-data-status neutral';
            
            const histogram = macd - (macd - 0.1 + Math.random() * 0.2);
            document.getElementById('histogramValue').textContent = histogram.toFixed(4);
            document.getElementById('histogramStatus').textContent = histogram > 0 ? 'Bullish' : 'Bearish';
            document.getElementById('histogramStatus').className = 'indicator-data-status ' + (histogram > 0 ? 'bullish' : 'bearish');
            
            // Simulate Volume
            const volume = Math.floor(Math.random() * 10000000);
            document.getElementById('volumeValue').textContent = volume.toLocaleString();
            document.getElementById('volumeStatus').textContent = 'Normal';
            document.getElementById('volumeStatus').className = 'indicator-data-status neutral';
            
            const volumeMA = Math.floor(Math.random() * 8000000);
            document.getElementById('volumeMAValue').textContent = volumeMA.toLocaleString();
            document.getElementById('volumeMAStatus').textContent = 'Volume Moving Average';
            document.getElementById('volumeMAStatus').className = 'indicator-data-status neutral';
        }
        
        // Mock volume chart (in a real app, this would use Chart.js or similar)
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch data for the current symbol
            const currentSymbol = document.getElementById('symbol').value || '{{ symbol if symbol else "AAPL" }}';
            fetchStockData(currentSymbol);
            
            // Fetch data for all popular stocks
            fetchAllStockData();
            
            // Fetch market indices data
            fetchMarketIndices();
            
            // Update chart with default data
            const urlParams = new URLSearchParams(window.location.search);
            const symbol = urlParams.get('symbol') || currentSymbol;
            const period = urlParams.get('period') || '1d';
            updateChart(symbol, period);
            
            // Fetch 1-day prediction
            fetch1dPrediction(symbol);
            
            // Update technical indicators
            updateTechnicalIndicators(symbol, period);
            
            const volumeChart = document.getElementById('volumeChart');
            if (volumeChart) {
                volumeChart.getContext = function() {
                    return {
                        fillRect: function() {},
                        beginPath: function() {},
                        moveTo: function() {},
                        lineTo: function() {},
                        stroke: function() {}
                    };
                };
            }
        });
        
        // Fetch and display live news
        function fetchLiveNews() {
            fetch('/get_news')
                .then(response => response.json())
                .then(data => {
                    const newsContainer = document.getElementById('news-container');
                    const lastUpdatedElement = document.getElementById('news-last-updated');
                    
                    if (data.articles && data.articles.length > 0) {
                        let newsHTML = '';
                        data.articles.forEach(article => {
                            newsHTML += `
                                <div style="padding: 12px 0; border-bottom: 1px solid #334155;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <h4 style="margin: 0; font-size: 15px; font-weight: 600; color: #e2e8f0;">${article.title}</h4>
                                        <span style="font-size: 12px; color: #94a3b8;">${article.timestamp}</span>
                                    </div>
                                    <p style="margin: 0; font-size: 13px; color: #cbd5e1; line-height: 1.4;">${article.summary}</p>
                                </div>
                            `;
                        });
                        newsContainer.innerHTML = newsHTML;
                        lastUpdatedElement.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                    } else {
                        newsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">No news available at the moment</div>';
                        lastUpdatedElement.textContent = 'No updates';
                    }
                })
                .catch(error => {
                    console.error('Error fetching news:', error);
                    document.getElementById('news-container').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Error loading news</div>';
                    document.getElementById('news-last-updated').textContent = 'Error';
                });
        }
        
        // Initialize news fetching and set up 5-minute interval
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch news immediately
            fetchLiveNews();
            
            // Set up interval to fetch news every 5 minutes (300000 milliseconds)
            setInterval(fetchLiveNews, 300000);
        });
    </script>
</body>
</html>