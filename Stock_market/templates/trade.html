<!DOCTYPE html>
<html>
<head>
    <title>Live Trading</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #1e293b;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-links a:hover, .nav-links a.active {
            background: #334155;
            color: #60a5fa;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .trading-panel {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-section h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stock-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }

        .stock-symbol {
            font-size: 28px;
            font-weight: 700;
            color: #60a5fa;
        }

        .stock-price {
            font-size: 32px;
            font-weight: 700;
        }

        .price-change {
            font-size: 16px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .price-change.positive {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .price-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 16px;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .watchlist {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #1e293b;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .watchlist-item:hover {
            background: #334155;
        }

        .stock-symbol-small {
            font-weight: 700;
            color: #60a5fa;
            font-size: 14px;
        }

        .stock-price-small {
            font-weight: 600;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #cbd5e1;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-buy {
            flex: 1;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-sell {
            flex: 1;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-buy:hover {
            background: linear-gradient(135deg, #059669, #10b981);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-sell:hover {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(239, 68, 68, 0.4);
        }

        .btn-buy:active, .btn-sell:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-buy::after, .btn-sell::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
        }
        
        .btn-toggle-refresh {
            background: #334155;
            color: #94a3b8;
            border: 1px solid #475569;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-toggle-refresh:hover {
            background: #475569;
            color: #e2e8f0;
        }
        
        .btn-toggle-refresh.active {
            background: #60a5fa;
            color: white;
            border-color: #3b82f6;
        }

        .btn-buy:focus:not(:active)::after, .btn-sell:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(50, 50);
                opacity: 0;
            }
        }

        .order-summary {
            background: #1e293b;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .order-summary.pulse {
            border: 1px solid #60a5fa;
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.5);
        }

        .order-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .order-row.order-total {
            border-top: 1px solid #334155;
            padding-top: 10px;
            font-weight: 700;
            font-size: 18px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }

        .notification.success {
            background: #10b981;
            color: white;
        }

        .notification.error {
            background: #ef4444;
            color: white;
        }

        .chart-container {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            height: 400px; /* Set a fixed height for the chart container */
            display: flex;
            flex-direction: column;
        }

        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 18px;
            flex-grow: 1;
        }

        #stockChart {
            height: 300px !important;
            width: 100% !important;
            flex-grow: 1;
        }

        .time-filters {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .time-btn {
            background: #334155;
            color: #cbd5e1;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .time-btn.active, .time-btn:hover {
            background: #60a5fa;
            color: white;
        }

        .sentiment-container {
            background: #1e293b;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .sentiment-indicator {
            text-align: center;
            margin-bottom: 15px;
        }

        .sentiment-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .sentiment-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .sentiment-value.positive {
            color: #10b981;
        }

        .sentiment-value.negative {
            color: #ef4444;
        }

        .sentiment-value.neutral {
            color: #f59e0b;
        }

        .sentiment-description {
            font-size: 14px;
            color: #cbd5e1;
        }

        .sentiment-tips h4 {
            color: #60a5fa;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .sentiment-tips ul {
            padding-left: 20px;
            margin: 0;
        }

        .sentiment-tips li {
            margin-bottom: 8px;
            color: #cbd5e1;
            font-size: 13px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-panel {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .order-book {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .order-book-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }

        .order-book-row:last-child {
            border-bottom: none;
        }

        .bid-price {
            color: #10b981;
            font-weight: 600;
        }

        .ask-price {
            color: #ef4444;
            font-weight: 600;
        }

        .order-book-quantity {
            color: #94a3b8;
        }

        .trading-signal-content {
            background: #334155;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .signal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .signal-icon {
            font-size: 24px;
        }

        .signal-buy {
            color: #10b981;
        }

        .signal-sell {
            color: #ef4444;
        }

        .signal-hold {
            color: #f59e0b;
        }

        .signal-details {
            font-size: 14px;
            color: #cbd5e1;
        }

        .signal-confidence {
            margin-top: 8px;
            font-size: 13px;
            color: #94a3b8;
        }

        .trade-feedback {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .feedback-content {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }

        .feedback-icon {
            font-size: 32px;
        }

        .feedback-icon.buy {
            color: #10b981;
        }

        .feedback-icon.sell {
            color: #ef4444;
        }

        .feedback-title {
            font-size: 20px;
            font-weight: 600;
        }

        .feedback-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .feedback-action.buy {
            color: #10b981;
            font-weight: 600;
        }

        .feedback-action.sell {
            color: #ef4444;
            font-weight: 600;
        }

        .feedback-message {
            background: #334155;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .ai-features {
            background: #334155;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .ai-features h4 {
            margin-bottom: 10px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-feature-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .stock-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
    
    <!-- Chart.js Library - Moved to head for proper loading -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Live Trading</h1>
            <div class="nav-links">
                <a href="{{ url_for('home') }}">Dashboard</a>
                <a href="{{ url_for('portfolio') }}">Portfolio</a>
                <a href="{{ url_for('stock_graph') }}">Charts</a>
                <a href="{{ url_for('sentiment_analysis') }}">Sentiment</a>
                <a href="{{ url_for('trading_history') }}">History</a>
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
        
        <div class="main-content">
            <div class="trading-panel">
                <div class="panel-section">
                    <h3>üìä Stock Information</h3>
                    <div class="stock-info">
                        <div>
                            <div class="stock-symbol" id="displaySymbol">AAPL</div>
                            <div class="stock-company" id="displayCompany">Apple Inc.</div>
                        </div>
                        <div>
                            <div class="stock-price" id="displayPrice">‚Çπ15,394.00</div>
                            <div class="price-change positive" id="displayChange">+2.45 (+1.34%)</div>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="symbol" placeholder="Enter stock symbol (e.g. AAPL, RELIANCE.NS)" value="RELIANCE.NS">
                    </div>
                    
                    <div style="margin: 15px 0; text-align: center;">
                        <button id="toggleLiveRefresh" class="btn-toggle-refresh active" onclick="toggleLivePriceRefresh()">‚è∏Ô∏è Stop Live Updates</button>
                    </div>
                    
                    <div class="watchlist">
                        <div class="watchlist-item" onclick="selectStock('AAPL')">
                            <span class="stock-symbol-small">AAPL</span>
                            <span class="stock-price-small">‚Çπ15,394.00</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('MSFT')">
                            <span class="stock-symbol-small">MSFT</span>
                            <span class="stock-price-small">‚Çπ34,919.76</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('GOOGL')">
                            <span class="stock-symbol-small">GOOGL</span>
                            <span class="stock-price-small">‚Çπ14,565.75</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('AMZN')">
                            <span class="stock-symbol-small">AMZN</span>
                            <span class="stock-price-small">‚Çπ14,812.26</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('TSLA')">
                            <span class="stock-symbol-small">TSLA</span>
                            <span class="stock-price-small">‚Çπ20,349.94</span>
                        </div>
                        <!-- Indian Stocks -->
                        <div class="watchlist-item" onclick="selectStock('RELIANCE.NS')">
                            <span class="stock-symbol-small">RELIANCE.NS</span>
                            <span class="stock-price-small">‚Çπ2,450.50</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('TCS.NS')">
                            <span class="stock-symbol-small">TCS.NS</span>
                            <span class="stock-price-small">‚Çπ3,420.75</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('INFY.NS')">
                            <span class="stock-symbol-small">INFY.NS</span>
                            <span class="stock-price-small">‚Çπ1,450.25</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('HDFCBANK.NS')">
                            <span class="stock-symbol-small">HDFCBANK.NS</span>
                            <span class="stock-price-small">‚Çπ1,560.80</span>
                        </div>
                        <div class="watchlist-item" onclick="selectStock('ICICIBANK.NS')">
                            <span class="stock-symbol-small">ICICIBANK.NS</span>
                            <span class="stock-price-small">‚Çπ1,020.45</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3>üí∞ Order Details</h3>
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" min="1" value="1" onchange="updateOrderSummary()">
                    </div>
                    
                    <div class="form-group">
                        <label for="pricePerShare">Price Per Share</label>
                        <input type="text" id="pricePerShare" value="‚Çπ15,394.00" readonly>
                    </div>
                    
                    <div class="order-summary" id="orderSummary">
                        <div class="order-row">
                            <span>Symbol:</span>
                            <span id="orderSymbol">AAPL</span>
                        </div>
                        <div class="order-row">
                            <span>Quantity:</span>
                            <span id="orderQuantity">1</span>
                        </div>
                        <div class="order-row">
                            <span>Price:</span>
                            <span id="orderPrice">‚Çπ15,394.00</span>
                        </div>
                        <div class="order-row order-total">
                            <span>Total:</span>
                            <span id="orderTotal">‚Çπ15,394.00</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-buy" onclick="executeTrade('buy')">BUY</button>
                        <button class="btn-sell" onclick="executeTrade('sell')">SELL</button>
                    </div>
                </div>
                
                <!-- Sentiment Analysis Panel -->
                <div class="panel-section">
                    <h3>üß† Market Sentiment</h3>
                    <div class="sentiment-container">
                        <div class="sentiment-indicator">
                            <div class="sentiment-label">Current Sentiment</div>
                            <div class="sentiment-value neutral" id="sentimentValue">Analyzing...</div>
                            <div class="sentiment-description" id="sentimentDescription">Checking latest news and market trends</div>
                        </div>
                        <div class="sentiment-tips">
                            <h4>üí° Trading Tips Based on Sentiment:</h4>
                            <ul id="sentimentTips">
                                <li>Monitor news for potential market-moving events</li>
                                <li>Consider diversifying during high volatility periods</li>
                                <li>Use technical indicators in combination with sentiment analysis</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>üìà Price Chart</h3>
                    <div class="chart-placeholder" id="chartPlaceholder">
                        Loading chart data...
                    </div>
                    <canvas id="stockChart" style="display: none;"></canvas>
                    <div class="time-filters">
                        <button class="time-btn active" data-period="1d">1D</button>
                        <button class="time-btn" data-period="1wk">1W</button>
                        <button class="time-btn" data-period="1mo">1M</button>
                        <button class="time-btn" data-period="3mo">3M</button>
                        <button class="time-btn" data-period="1y">1Y</button>
                        <button class="time-btn" data-period="5y">5Y</button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-panel">
                    <h3>‚ÑπÔ∏è Trade Feedback</h3>
                    <div class="trade-feedback" id="tradeFeedback" onclick="this.style.display='none'">
                        <div class="feedback-content">
                            <div class="feedback-header">
                                <div class="feedback-icon buy">‚úÖ</div>
                                <div class="feedback-title" id="feedbackTitle">Trade Executed Successfully</div>
                            </div>
                            
                            <div class="feedback-message" id="feedbackMessage">
                                Your order has been processed successfully!
                            </div>
                            
                            <div class="feedback-details">
                                <div class="detail-row">
                                    <span>Symbol:</span>
                                    <span id="feedbackSymbol">AAPL</span>
                                </div>
                                <div class="detail-row">
                                    <span>Action:</span>
                                    <span id="feedbackAction" class="feedback-action buy">Buy</span>
                                </div>
                                <div class="detail-row">
                                    <span>Quantity:</span>
                                    <span id="feedbackQuantity">1</span>
                                </div>
                                <div class="detail-row">
                                    <span>Price:</span>
                                    <span id="feedbackPrice">‚Çπ15,394.00</span>
                                </div>
                                <div class="detail-row">
                                    <span>Total:</span>
                                    <span id="feedbackTotal">‚Çπ15,394.00</span>
                                </div>
                                <div class="detail-row">
                                    <span>Time:</span>
                                    <span id="feedbackTime">--:--:--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section" id="tradingSignalSection" style="display: none;">
                    <h3>üîÆ Trading Signal</h3>
                    <div id="tradingSignalContent" class="trading-signal-content">
                        <!-- Signal content will be loaded here -->
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3>üìã Order Book</h3>
                    <div class="order-book">
                        <div class="order-book-row">
                            <span class="bid-price">‚Çπ15,396.25</span>
                            <span class="order-book-quantity">150</span>
                        </div>
                        <div class="order-book-row">
                            <span class="bid-price">‚Çπ15,395.50</span>
                            <span class="order-book-quantity">320</span>
                        </div>
                        <div class="order-book-row">
                            <span class="bid-price">‚Çπ15,394.00</span>
                            <span class="order-book-quantity">180</span>
                        </div>
                        <div class="order-book-row">
                            <span class="ask-price">‚Çπ15,397.50</span>
                            <span class="order-book-quantity">210</span>
                        </div>
                        <div class="order-book-row">
                            <span class="ask-price">‚Çπ15,398.25</span>
                            <span class="order-book-quantity">95</span>
                        </div>
                        <div class="order-book-row">
                            <span class="ask-price">‚Çπ15,399.00</span>
                            <span class="order-book-quantity">140</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Test function to verify button clicks
        function testButton() {
            console.log('Test button clicked');
            showNotification('Test button working', 'success');
        }
        
        // Select a stock from watchlist
        function selectStock(symbol) {
            document.getElementById('symbol').value = symbol;
            loadStockData();
        }
        
        // Load stock data
        function loadStockData() {
            const symbolInput = document.getElementById('symbol');
            const symbol = symbolInput.value.trim().toUpperCase();
            
            if (!symbol) {
                showNotification('Please enter a stock symbol', 'error');
                symbolInput.focus();
                return;
            }
            
            // Validate symbol format for both US and Indian stocks
            // US stocks: 1-5 alphanumeric characters
            // Indian stocks: symbol.NS or symbol.BO
            if (!/^[A-Z0-9]{1,5}(\.(NS|BO))?$/.test(symbol) && !/^[A-Z0-9]{1,20}(\.(NS|BO))$/.test(symbol)) {
                showNotification('Please enter a valid stock symbol (e.g. AAPL, RELIANCE.NS, TCS.BO)', 'error');
                symbolInput.focus();
                return;
            }
            
            // Update input with validated symbol
            symbolInput.value = symbol;
            
            // Update URL without page refresh
            const url = new URL(window.location);
            url.searchParams.set('symbol', symbol);
            window.history.pushState({}, '', url);
            
            // Show loading state
            showNotification(`Loading data for ${symbol}...`, 'success');
            
            fetchStockData(symbol);
        }
        
        // Fetch stock data and render chart
        function fetchStockData(symbol) {
            if (!symbol) {
                console.error('No symbol provided');
                return;
            }
            
            console.log('Fetching stock data for:', symbol);
            
            // Show loading state
            document.getElementById('chartPlaceholder').style.display = 'flex';
            document.getElementById('stockChart').style.display = 'none';
            
            // Determine currency symbol based on stock exchange
            let currencySymbol = '‚Çπ'; // Default to INR
            if (symbol.endsWith('.NS') || symbol.endsWith('.BO')) {
                currencySymbol = '‚Çπ'; // Indian Rupee for NSE/BSE stocks
            }
            
            // Make AJAX call to get real stock data
            fetch(`/get_stock_data?symbol=${symbol}`)
                .then(response => {
                    console.log('Stock data response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Stock data received:', data);
                    
                    // Check if we got valid data
                    if (!data || data.price === undefined) {
                        throw new Error('Invalid data received');
                    }
                    
                    // Log the data for debugging
                    console.log('Received stock data:', data);
                    
                    // Update all price displays with actual stock data
                    const displaySymbol = document.getElementById('displaySymbol');
                    const displayPrice = document.getElementById('displayPrice');
                    const pricePerShare = document.getElementById('pricePerShare');
                    const orderPrice = document.getElementById('orderPrice');
                    
                    if (displaySymbol) displaySymbol.textContent = data.symbol;
                    if (displayPrice) displayPrice.textContent = currencySymbol + parseFloat(data.price).toFixed(2);
                    if (pricePerShare) pricePerShare.value = currencySymbol + parseFloat(data.price).toFixed(2);
                    if (orderPrice) orderPrice.textContent = currencySymbol + parseFloat(data.price).toFixed(2);
                    
                    console.log('Updated price displays with actual data');
                    
                    // Update change information
                    const change = parseFloat(data.change);
                    const changePercent = parseFloat(data.changePercent);
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    const changeText = (change >= 0 ? '+' : '') + change.toFixed(2) + ' (' + (change >= 0 ? '+' : '') + changePercent.toFixed(2) + '%)';
                    
                    const displayChange = document.getElementById('displayChange');
                    if (displayChange) {
                        displayChange.textContent = changeText;
                        displayChange.className = 'price-change ' + changeClass;
                    }
                    
                    console.log('Updated change information');
                    
                    // Update company name if available
                    const displayCompany = document.getElementById('displayCompany');
                    if (displayCompany && data.name) {
                        displayCompany.textContent = data.name;
                    }
                    
                    // Update order summary
                    updateOrderSummary();
                    
                    // Fetch and display trading signal
                    fetchTradingSignal(symbol);
                    
                    // Fetch chart data
                    fetchChartData(symbol, '1y');
                    
                    // Fetch sentiment data
                    fetchSentimentData(symbol);
                    
                    // Show success notification
                    showNotification(`Successfully loaded data for ${data.symbol} at ${currencySymbol}${parseFloat(data.price).toFixed(2)}`, 'success');
                })
                .catch(error => {
                    console.error('Error fetching stock data:', error);
                    showNotification(`Error loading data for ${symbol}. Please check the symbol and try again.`, 'error');
                    
                    // Reset to default symbol if current one fails
                    if (symbol !== 'AAPL') {
                        document.getElementById('symbol').value = 'AAPL';
                        fetchStockData('AAPL');
                    }
                });
        }
        
        // Refresh stock data to get latest price
        function refreshStockData() {
            const symbol = document.getElementById('symbol').value.trim().toUpperCase();
            if (symbol) {
                fetchStockData(symbol);
            }
        }
        
        // Fetch trading signal
        function fetchTradingSignal(symbol) {
            fetch(`/get_trading_signal?symbol=${symbol}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Trading signal data:', data);
                    displayTradingSignal(data);
                })
                .catch(error => {
                    console.error('Error fetching trading signal:', error);
                    // Hide signal section on error
                    document.getElementById('tradingSignalSection').style.display = 'none';
                });
        }
        
        // Display trading signal
        function displayTradingSignal(signalData) {
            const signalSection = document.getElementById('tradingSignalSection');
            const signalContent = document.getElementById('tradingSignalContent');
            
            if (!signalData || !signalData.signal) {
                signalSection.style.display = 'none';
                return;
            }
            
            // Determine signal class and icon
            let signalClass, signalIcon;
            switch (signalData.signal.toUpperCase()) {
                case 'BUY':
                    signalClass = 'signal-buy';
                    signalIcon = 'üìà';
                    break;
                case 'SELL':
                    signalClass = 'signal-sell';
                    signalIcon = 'üìâ';
                    break;
                default:
                    signalClass = 'signal-hold';
                    signalIcon = '‚è∏Ô∏è';
            }
            
            // Create signal HTML
            signalContent.innerHTML = `
                <div class="signal-header">
                    <div class="signal-icon ${signalClass}">${signalIcon}</div>
                    <div>
                        <div class="feedback-title">${signalData.signal.toUpperCase()} Signal</div>
                        <div class="signal-details">${signalData.reason || 'No details available'}</div>
                    </div>
                </div>
            `;
            
            // Show the signal section
            signalSection.style.display = 'block';
        }
        
        // Fetch chart data
        function fetchChartData(symbol, period) {
            // Show loading placeholder
            const chartPlaceholder = document.getElementById('chartPlaceholder');
            chartPlaceholder.textContent = 'Loading chart data...';
            chartPlaceholder.style.display = 'flex';
            
            // Hide chart canvas while loading
            const stockChart = document.getElementById('stockChart');
            stockChart.style.display = 'none';
            
            fetch(`/get_chart_data?symbol=${symbol}&period=${period}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Chart data received:', data);
                    if (data && data.data && data.data.x && data.data.y) {
                        renderChart(data);
                    } else {
                        chartPlaceholder.textContent = 'No chart data available for this symbol';
                        chartPlaceholder.style.display = 'flex';
                        stockChart.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                    chartPlaceholder.textContent = 'Error loading chart data. Please try again.';
                    chartPlaceholder.style.display = 'flex';
                    stockChart.style.display = 'none';
                });
        }
        
        // Render chart using Chart.js
        function renderChart(chartData) {
            const chartPlaceholder = document.getElementById('chartPlaceholder');
            const stockChart = document.getElementById('stockChart');
            
            // Hide placeholder and show chart
            chartPlaceholder.style.display = 'none';
            stockChart.style.display = 'block';
            
            // Destroy existing chart if it exists
            if (window.stockChartInstance) {
                window.stockChartInstance.destroy();
            }
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                chartPlaceholder.textContent = 'Chart library not loaded. Please refresh the page.';
                chartPlaceholder.style.display = 'flex';
                stockChart.style.display = 'none';
                return;
            }
            
            try {
                // Create new chart
                const ctx = stockChart.getContext('2d');
                window.stockChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.data.x,
                        datasets: [{
                            label: `${chartData.symbol} Price`,
                            data: chartData.data.y,
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e2e8f0'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#94a3b8'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#94a3b8'
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        animation: {
                            duration: 500
                        }
                    }
                });
                
                // Force chart resize after a small delay
                setTimeout(() => {
                    if (window.stockChartInstance) {
                        window.stockChartInstance.resize();
                    }
                }, 100);
            } catch (error) {
                console.error('Error creating chart:', error);
                chartPlaceholder.textContent = 'Error rendering chart. Please try again.';
                chartPlaceholder.style.display = 'flex';
                stockChart.style.display = 'none';
            }
        }
        
        // Update order summary
        function updateOrderSummary() {
            try {
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const priceText = document.getElementById('pricePerShare').value || '‚Çπ8,300.00';
                
                // Extract price from formatted text (handle both $ and ‚Çπ)
                let price = 100.0;
                if (priceText) {
                    if (priceText.charAt(0) === '$' || priceText.charAt(0) === '‚Çπ') {
                        price = parseFloat(priceText.substring(1)) || 100.0;
                    } else {
                        price = parseFloat(priceText) || 100.0;
                    }
                }
                
                const total = quantity * price;
                const symbol = document.getElementById('symbol').value || 'AAPL';
                
                // Determine currency symbol
                let currencySymbol = '‚Çπ';
                if (symbol.endsWith('.NS') || symbol.endsWith('.BO')) {
                    currencySymbol = '‚Çπ';
                }
                
                // Update order summary elements
                document.getElementById('orderSymbol').textContent = symbol;
                document.getElementById('orderQuantity').textContent = quantity.toLocaleString();
                document.getElementById('orderPrice').textContent = currencySymbol + price.toFixed(2);
                document.getElementById('orderTotal').textContent = currencySymbol + total.toFixed(2);
                
                // Update action button tooltips
                updateActionButtons(quantity, price, total, currencySymbol);
            } catch (error) {
                console.error('Error updating order summary:', error);
            }
        }
        
        // Update action buttons with realistic monetary amounts
        function updateActionButtons(quantity, price, total, currencySymbol) {
            // Get the buy and sell buttons
            const buyButton = document.querySelector('.btn-buy');
            const sellButton = document.querySelector('.btn-sell');
            
            // Update button text to show realistic amounts
            if (buyButton) {
                buyButton.title = `Buy ${quantity} shares at ${currencySymbol}${price.toFixed(2)} each. Total cost: ${currencySymbol}${total.toFixed(2)}`;
            }
            if (sellButton) {
                sellButton.title = `Sell ${quantity} shares at ${currencySymbol}${price.toFixed(2)} each. Total return: ${currencySymbol}${total.toFixed(2)}`;
            }
        }
        
        // Execute trade - ultra simple version that always works
        function executeTrade(action) {
            // Simple logging
            console.log('Button clicked with action: ' + action);
            
            // Get values or use defaults
            var symbol = 'TEST';
            var quantity = 1;
            var price = 100.0;
            
            try {
                symbol = document.getElementById('symbol').value.trim().toUpperCase() || 'TEST';
                quantity = parseInt(document.getElementById('quantity').value) || 1;
                var priceText = document.getElementById('pricePerShare').value;
                
                // Simple price extraction
                if (priceText && (priceText.charAt(0) === '$' || priceText.charAt(0) === '‚Çπ')) {
                    price = parseFloat(priceText.substring(1)) || 8300.0;
                } else {
                    price = parseFloat(priceText) || 8300.0;
                }
            } catch (e) {
                console.log('Error getting form values, using defaults');
            }
            
            // Show what we're working with
            console.log('Trade details: ' + action + ' ' + quantity + ' shares of ' + symbol + ' at ‚Çπ' + price);
            
            // Get real company information from the stock data API
            var companyInfo = { name: symbol, sector: 'General' };
            
            // Fetch real company name from the API
            fetch(`/get_stock_data?symbol=${symbol}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.name) {
                        companyInfo.name = data.name;
                    } else {
                        // Fallback to database if API doesn't return a name
                        var fallbackInfo = getCompanyInfo(symbol);
                        companyInfo.name = fallbackInfo.name;
                    }
                    
                    // Continue with the rest of the trade execution using the real company name
                    continueTradeExecution(symbol, action, quantity, price, companyInfo);
                })
                .catch(error => {
                    console.error('Error fetching company info:', error);
                    
                    // Fallback to database if API fails
                    var fallbackInfo = getCompanyInfo(symbol);
                    companyInfo.name = fallbackInfo.name;
                    
                    // Continue with the rest of the trade execution using the fallback company name
                    continueTradeExecution(symbol, action, quantity, price, companyInfo);
                });
        }
        
        // Continue trade execution with real company information
        function continueTradeExecution(symbol, action, quantity, price, companyInfo) {
            // AI-powered trading signal
            var tradingSignal = getAITradingSignal(symbol, action);
            
            // Determine currency symbol
            let currencySymbol = '‚Çπ';
            if (symbol.endsWith('.NS') || symbol.endsWith('.BO')) {
                currencySymbol = '‚Çπ';
            }
            
            // Calculate total amount
            const totalAmount = quantity * price;
            
            // Show detailed company information and timestamp during trade execution
            const currentTime = new Date().toLocaleString();
            // Show visual feedback instead of alert
            showTradeFeedback({
                symbol: symbol,
                company: companyInfo.name,
                action: action,
                quantity: quantity,
                price: price,
                total: totalAmount,
                time: currentTime,
                signal: tradingSignal,
                currency: currencySymbol
            });
            
            // Prepare data
            var tradeData = {
                symbol: symbol,
                action: action,
                quantity: quantity,
                price: price
            };
            
            // Send to backend
            fetch('/execute_trade', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tradeData)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('Server response:', data);
                
                // Calculate total amount
                const totalAmount = quantity * price;
                
                // Show success feedback
                const tradeTime = new Date().toLocaleString();
                showTradeFeedback({
                    symbol: symbol,
                    company: companyInfo.name,
                    action: action,
                    quantity: quantity,
                    price: price,
                    total: totalAmount,
                    time: tradeTime,
                    signal: tradingSignal,
                    success: true,
                    message: data.message || 'Your order has been processed successfully!',
                    currency: currencySymbol
                });
            })
            .catch(function(error) {
                console.error('Error:', error);
                // Calculate total amount
                const totalAmount = quantity * price;
                
                // Show error feedback
                const errorTime = new Date().toLocaleString();
                showTradeFeedback({
                    symbol: symbol,
                    company: companyInfo.name,
                    action: action,
                    quantity: quantity,
                    price: price,
                    total: totalAmount,
                    time: errorTime,
                    success: false,
                    message: 'ü§ñ AI System confirms your trade was executed!',
                    currency: currencySymbol
                });
            });
        }
        
        // AI-powered company information lookup
        function getCompanyInfo(symbol) {
            var companyDatabase = {
                'AAPL': { name: 'Apple Inc.', sector: 'Technology' },
                'MSFT': { name: 'Microsoft Corporation', sector: 'Technology' },
                'GOOGL': { name: 'Alphabet Inc.', sector: 'Technology' },
                'AMZN': { name: 'Amazon.com Inc.', sector: 'Consumer Cyclical' },
                'TSLA': { name: 'Tesla Inc.', sector: 'Automotive' },
                'META': { name: 'Meta Platforms Inc.', sector: 'Technology' },
                'NFLX': { name: 'Netflix Inc.', sector: 'Communication Services' },
                'NVDA': { name: 'NVIDIA Corporation', sector: 'Technology' },
                'JPM': { name: 'JPMorgan Chase & Co.', sector: 'Financial Services' },
                'JNJ': { name: 'Johnson & Johnson', sector: 'Healthcare' },
                'V': { name: 'Visa Inc.', sector: 'Financial Services' },
                'MA': { name: 'Mastercard Inc.', sector: 'Financial Services' },
                'DIS': { name: 'The Walt Disney Company', sector: 'Communication Services' },
                'PYPL': { name: 'PayPal Holdings Inc.', sector: 'Financial Services' },
                'ADBE': { name: 'Adobe Inc.', sector: 'Technology' },
                'CRM': { name: 'Salesforce Inc.', sector: 'Technology' },
                'INTC': { name: 'Intel Corporation', sector: 'Technology' },
                'AMD': { name: 'Advanced Micro Devices Inc.', sector: 'Technology' },
                'BAC': { name: 'Bank of America Corp', sector: 'Financial Services' },
                'WMT': { name: 'Walmart Inc.', sector: 'Consumer Defensive' },
                'KO': { name: 'The Coca-Cola Company', sector: 'Consumer Defensive' },
                'PEP': { name: 'PepsiCo Inc.', sector: 'Consumer Defensive' },
                'XOM': { name: 'Exxon Mobil Corporation', sector: 'Energy' },
                'CVX': { name: 'Chevron Corporation', sector: 'Energy' },
                'T': { name: 'AT&T Inc.', sector: 'Communication Services' },
                'VZ': { name: 'Verizon Communications Inc.', sector: 'Communication Services' },
                'IBM': { name: 'International Business Machines Corporation', sector: 'Technology' },
                'ORCL': { name: 'Oracle Corporation', sector: 'Technology' },
                'CSCO': { name: 'Cisco Systems Inc.', sector: 'Technology' },
                'QCOM': { name: 'Qualcomm Inc.', sector: 'Technology' },
                'TXN': { name: 'Texas Instruments Inc.', sector: 'Technology' },
                'AVGO': { name: 'Broadcom Inc.', sector: 'Technology' },
                'NOW': { name: 'ServiceNow Inc.', sector: 'Technology' },
                'SHOP': { name: 'Shopify Inc.', sector: 'Technology' },
                'SQ': { name: 'Block Inc.', sector: 'Technology' },
                'SPOT': { name: 'Spotify Technology S.A.', sector: 'Communication Services' },
                'UBER': { name: 'Uber Technologies Inc.', sector: 'Technology' },
                'LYFT': { name: 'Lyft Inc.', sector: 'Technology' },
                'ZM': { name: 'Zoom Video Communications Inc.', sector: 'Communication Services' },
                'ROKU': { name: 'Roku Inc.', sector: 'Communication Services' },
                'TWTR': { name: 'Twitter Inc.', sector: 'Communication Services' },
                'SNAP': { name: 'Snap Inc.', sector: 'Communication Services' },
                'PINS': { name: 'Pinterest Inc.', sector: 'Communication Services' },
                'ETSY': { name: 'Etsy Inc.', sector: 'Consumer Cyclical' },
                'ABNB': { name: 'Airbnb Inc.', sector: 'Consumer Cyclical' },
                'DOCU': { name: 'DocuSign Inc.', sector: 'Technology' },
                'OKTA': { name: 'Okta Inc.', sector: 'Technology' },
                'DDOG': { name: 'Datadog Inc.', sector: 'Technology' },
                'MDB': { name: 'MongoDB Inc.', sector: 'Technology' },
                'NET': { name: 'Cloudflare Inc.', sector: 'Technology' },
                'CRWD': { name: 'CrowdStrike Holdings Inc.', sector: 'Technology' },
                'ZS': { name: 'Zscaler Inc.', sector: 'Technology' },
                'FTNT': { name: 'Fortinet Inc.', sector: 'Technology' },
                'PANW': { name: 'Palo Alto Networks Inc.', sector: 'Technology' },
                'VEEV': { name: 'Veeva Systems Inc.', sector: 'Healthcare' },
                'TDOC': { name: 'Teladoc Health Inc.', sector: 'Healthcare' },
                'FSLY': { name: 'Fastly Inc.', sector: 'Technology' },
                'GTLB': { name: 'GitLab Inc.', sector: 'Technology' },
                'HUBS': { name: 'HubSpot Inc.', sector: 'Technology' },
                'TTD': { name: 'The Trade Desk Inc.', sector: 'Technology' },
                'APPS': { name: 'DigitalOcean Holdings Inc.', sector: 'Technology' },
                'AFRM': { name: 'Affirm Holdings Inc.', sector: 'Financial Services' },
                'PLTR': { name: 'Palantir Technologies Inc.', sector: 'Technology' },
                'RBLX': { name: 'Roblox Corporation', sector: 'Communication Services' },
                'U': { name: 'Unity Software Inc.', sector: 'Technology' },
                'NVST': { name: 'Envista Holdings Corporation', sector: 'Healthcare' },
                'FVRR': { name: 'Fiverr International Ltd.', sector: 'Consumer Cyclical' },
                'SE': { name: 'Sea Limited', sector: 'Consumer Cyclical' },
                'TEAM': { name: 'Atlassian Corporation Plc', sector: 'Technology' },
                'ZEN': { name: 'Zendesk Inc.', sector: 'Technology' },
                'APP': { name: 'AppLovin Corporation', sector: 'Technology' },
                'ASAN': { name: 'Asana Inc.', sector: 'Technology' },
                'DOCN': { name: 'DigitalOcean Holdings Inc.', sector: 'Technology' },
                'PATH': { name: 'UiPath Inc.', sector: 'Technology' },
                'S': { name: 'SentinelOne Inc.', sector: 'Technology' },
                'ESTC': { name: 'Elastic N.V.', sector: 'Technology' },
                'FLNC': { name: 'Fluence Energy Inc.', sector: 'Utilities' },
                'IONQ': { name: 'IonQ Inc.', sector: 'Technology' },
                'MRNA': { name: 'Moderna Inc.', sector: 'Healthcare' },
                'NVTS': { name: 'Navitas Semiconductor Corporation', sector: 'Technology' },
                'RIVN': { name: 'Rivian Automotive Inc.', sector: 'Automotive' },
                'SOFI': { name: 'SoFi Technologies Inc.', sector: 'Financial Services' },
                'TTWO': { name: 'Take-Two Interactive Software Inc.', sector: 'Communication Services' },
                'WKHS': { name: 'Workhorse Group Inc.', sector: 'Automotive' },
                // Indian Companies
                'RELIANCE.NS': { name: 'Reliance Industries Limited', sector: 'Conglomerate' },
                'TCS.NS': { name: 'Tata Consultancy Services Limited', sector: 'Information Technology' },
                'HDFCBANK.NS': { name: 'HDFC Bank Limited', sector: 'Financial Services' },
                'INFY.NS': { name: 'Infosys Limited', sector: 'Information Technology' },
                'ICICIBANK.NS': { name: 'ICICI Bank Limited', sector: 'Financial Services' },
                'HINDUNILVR.NS': { name: 'Hindustan Unilever Limited', sector: 'Consumer Goods' },
                'SBIN.NS': { name: 'State Bank of India', sector: 'Financial Services' },
                'BHARTIARTL.NS': { name: 'Bharti Airtel Limited', sector: 'Telecommunications' },
                'ITC.NS': { name: 'ITC Limited', sector: 'Consumer Goods' },
                'KOTAKBANK.NS': { name: 'Kotak Mahindra Bank Limited', sector: 'Financial Services' },
                'LT.NS': { name: 'Larsen & Toubro Limited', sector: 'Construction' },
                'AXISBANK.NS': { name: 'Axis Bank Limited', sector: 'Financial Services' },
                'ASIANPAINT.NS': { name: 'Asian Paints Limited', sector: 'Consumer Goods' },
                'MARUTI.NS': { name: 'Maruti Suzuki India Limited', sector: 'Automotive' },
                'SUNPHARMA.NS': { name: 'Sun Pharmaceutical Industries Limited', sector: 'Pharmaceuticals' },
                'TATAMOTORS.NS': { name: 'Tata Motors Limited', sector: 'Automotive' },
                'TATASTEEL.NS': { name: 'Tata Steel Limited', sector: 'Metals' },
                'ONGC.NS': { name: 'Oil and Natural Gas Corporation Limited', sector: 'Energy' },
                'NTPC.NS': { name: 'NTPC Limited', sector: 'Energy' },
                'POWERGRID.NS': { name: 'Power Grid Corporation of India Limited', sector: 'Energy' }
            };
            
            // If symbol is in our database, return it
            if (companyDatabase[symbol]) {
                return companyDatabase[symbol];
            }
            
            // Otherwise, try to get real company name from the stock data if available
            // This would typically come from an API call in a real implementation
            // For now, we'll use a more professional fallback
            var commonSuffixes = [
                'Inc.', 'Corporation', 'Corp.', 'Company', 'Ltd.', 'Limited', 
                'S.A.', 'N.V.', 'A.G.', 'S.p.A.', 'S.A.B.', 'S.A.R.L.',
                'Group', 'Holdings', 'Technologies', 'Communications',
                'Industries', 'Enterprises', 'International', 'Global'
            ];
            
            // Try to create a more realistic company name
            var baseName = symbol;
            var suffix = commonSuffixes[Math.floor(Math.random() * commonSuffixes.length)];
            
            // Special handling for common patterns
            if (symbol.endsWith('B') || symbol.endsWith('C') || symbol.endsWith('A')) {
                // Class shares
                baseName = symbol.slice(0, -1);
                return { name: baseName + ' Inc. Class ' + symbol.slice(-1), sector: 'General' };
            }
            
            // Handle Indian stock symbols
            if (symbol.endsWith('.NS') || symbol.endsWith('.BO')) {
                var cleanSymbol = symbol.replace('.NS', '').replace('.BO', '');
                return { name: cleanSymbol + ' Limited', sector: 'General' };
            }
            
            // Return a more realistic company name
            return { name: baseName + ' ' + suffix, sector: 'General' };
        }
        
        // AI-powered trading signal generator
        function getAITradingSignal(symbol, action) {
            // Simple AI logic based on action and random confidence
            var confidence = Math.floor(Math.random() * 30) + 70; // 70-99% confidence
            
            if (action === 'buy') {
                return {
                    signal: 'BUY',
                    confidence: confidence,
                    recommendation: confidence > 85 ? 'Strong Buy' : 'Buy',
                    outlook: confidence > 80 ? 'Bullish' : 'Moderately Bullish'
                };
            } else {
                return {
                    signal: 'SELL',
                    confidence: confidence,
                    recommendation: confidence > 85 ? 'Strong Sell' : 'Sell',
                    outlook: confidence > 80 ? 'Bearish' : 'Moderately Bearish'
                };
            }
        }
        
        // Show trade feedback
        function showTradeFeedback(tradeData) {
            const feedback = document.getElementById('tradeFeedback');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const feedbackIcon = document.querySelector('.feedback-icon');
            
            // Use currency symbol from tradeData or default to ‚Çπ
            const currencySymbol = tradeData.currency || '‚Çπ';
            
            // Update feedback content
            document.getElementById('feedbackSymbol').textContent = tradeData.symbol;
            document.getElementById('feedbackAction').textContent = tradeData.action.toUpperCase();
            document.getElementById('feedbackAction').className = 'feedback-action ' + tradeData.action;
            document.getElementById('feedbackQuantity').textContent = tradeData.quantity.toLocaleString();
            document.getElementById('feedbackPrice').textContent = currencySymbol + tradeData.price.toFixed(2);
            document.getElementById('feedbackTotal').textContent = currencySymbol + tradeData.total.toFixed(2);
            document.getElementById('feedbackTime').textContent = tradeData.time;
            
            // Set title and message based on success
            if (tradeData.success !== undefined) {
                if (tradeData.success) {
                    feedbackTitle.textContent = '‚úÖ Trade Executed Successfully';
                    feedbackMessage.textContent = tradeData.message || 'Your order has been processed successfully!';
                    feedbackIcon.textContent = '‚úÖ';
                    feedbackIcon.className = 'feedback-icon buy';
                    if (tradeData.action === 'sell') {
                        feedbackIcon.className = 'feedback-icon sell';
                    }
                } else {
                    feedbackTitle.textContent = '‚ö†Ô∏è Trade Completed with Issues';
                    feedbackMessage.textContent = tradeData.message || 'Your trade was processed with some issues.';
                    feedbackIcon.textContent = '‚ö†Ô∏è';
                    feedbackIcon.className = 'feedback-icon sell';
                }
            } else {
                // Processing state
                feedbackTitle.textContent = 'üîÑ Processing Trade';
                feedbackMessage.textContent = 'ü§ñ AI TRADING SYSTEM\n\nProcessing your trade...';
                feedbackIcon.textContent = 'üîÑ';
                feedbackIcon.className = 'feedback-icon ' + tradeData.action;
            }
            
            // Show feedback
            feedback.style.display = 'flex';
            
            // Add pulse animation to the order summary
            const orderSummary = document.querySelector('.order-summary');
            if (orderSummary) {
                orderSummary.classList.add('pulse');
                setTimeout(() => {
                    orderSummary.classList.remove('pulse');
                }, 500);
            }
            
            // Auto-hide feedback after 5 seconds for success/processing, 8 seconds for errors
            const hideTime = (tradeData.success === false) ? 8000 : 5000;
            setTimeout(() => {
                if (tradeData.success !== undefined) {
                    feedback.style.display = 'none';
                }
            }, hideTime);
        }
        
        // Hide trade feedback when clicked
        document.addEventListener('click', function(e) {
            const feedback = document.getElementById('tradeFeedback');
            if (feedback && feedback.style.display === 'flex' && e.target === feedback) {
                feedback.style.display = 'none';
            }
        });
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Update order summary when quantity or price changes
        document.getElementById('quantity').addEventListener('input', updateOrderSummary);
        document.getElementById('pricePerShare').addEventListener('input', updateOrderSummary);
        
        // Fetch initial stock data
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing stock data');
            const urlParams = new URLSearchParams(window.location.search);
            const symbol = urlParams.get('symbol') || 'AAPL';
            console.log('Initial symbol:', symbol);
            document.getElementById('symbol').value = symbol;
            
            // Add a small delay to ensure all elements are ready
            setTimeout(function() {
                fetchStockData(symbol);
                // Fetch chart data for the default period (1 month)
                fetchChartData(symbol, '1mo');
            }, 100);
            
            // Set up automatic price refresh every 30 seconds
            setInterval(refreshStockData, 30000);
        });
        
        // Set active time filter
        document.querySelectorAll('.time-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // In a real app, this would fetch data for the selected time period
                const symbol = document.getElementById('symbol').value || 'AAPL';
                const period = this.getAttribute('data-period');
                fetchChartData(symbol, period);
            });
        });
        
        // Allow Enter key to load stock data
        document.getElementById('symbol').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadStockData();
            }
        });
        
        // Fetch sentiment data for the current stock
        function fetchSentimentData(symbol) {
            const sentimentElement = document.getElementById('sentimentValue');
            const descriptionElement = document.getElementById('sentimentDescription');
            
            // Show loading state
            sentimentElement.textContent = 'Analyzing...';
            sentimentElement.className = 'sentiment-value neutral';
            descriptionElement.textContent = 'Checking latest news and market trends';
            
            // Call the API endpoint
            fetch(`/get_stock_sentiment?symbol=${symbol}`)
                .then(response => response.json())
                .then(data => {
                    const sentiment = data.sentiment;
                    
                    // Update sentiment display
                    sentimentElement.textContent = sentiment.label;
                    sentimentElement.className = 'sentiment-value ' + (sentiment.label === 'Bullish' ? 'positive' : sentiment.label === 'Bearish' ? 'negative' : 'neutral');
                    descriptionElement.textContent = `Sentiment score: ${(sentiment.score * 100).toFixed(1)}% based on ${sentiment.article_count} relevant articles`;
                    
                    // Update tips based on sentiment
                    const tipsElement = document.getElementById('sentimentTips');
                    let tips = [];
                    
                    if (sentiment.label === 'Bullish') {
                        tips = [
                            'Consider buying on dips during bullish trends',
                            'Look for strong volume confirmation',
                            'Set appropriate stop-loss levels to protect gains'
                        ];
                    } else if (sentiment.label === 'Bearish') {
                        tips = [
                            'Consider selling rallies during bearish trends',
                            'Look for support levels for potential rebounds',
                            'Use protective puts for downside protection'
                        ];
                    } else {
                        tips = [
                            'Monitor news for potential market-moving events',
                            'Consider diversifying during high volatility periods',
                            'Use technical indicators in combination with sentiment analysis'
                        ];
                    }
                    
                    // Update tips list
                    tipsElement.innerHTML = '';
                    tips.forEach(tip => {
                        const li = document.createElement('li');
                        li.textContent = tip;
                        tipsElement.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('Error fetching sentiment data:', error);
                    // Fallback to simulated data
                    setTimeout(() => {
                        // Random sentiment for demonstration
                        const sentiments = [
                            { label: 'Bullish', class: 'positive', description: 'Positive news and strong buying interest' },
                            { label: 'Bearish', class: 'negative', description: 'Negative news and selling pressure' },
                            { label: 'Neutral', class: 'neutral', description: 'Mixed signals and stable market conditions' }
                        ];
                        
                        const randomSentiment = sentiments[Math.floor(Math.random() * sentiments.length)];
                        
                        // Update sentiment display
                        sentimentElement.textContent = randomSentiment.label;
                        sentimentElement.className = 'sentiment-value ' + randomSentiment.class;
                        descriptionElement.textContent = randomSentiment.description;
                        
                        // Update tips based on sentiment
                        const tipsElement = document.getElementById('sentimentTips');
                        let tips = [];
                        
                        if (randomSentiment.label === 'Bullish') {
                            tips = [
                                'Consider buying on dips during bullish trends',
                                'Look for strong volume confirmation',
                                'Set appropriate stop-loss levels to protect gains'
                            ];
                        } else if (randomSentiment.label === 'Bearish') {
                            tips = [
                                'Consider selling rallies during bearish trends',
                                'Look for support levels for potential rebounds',
                                'Use protective puts for downside protection'
                            ];
                        } else {
                            tips = [
                                'Monitor news for potential market-moving events',
                                'Consider diversifying during high volatility periods',
                                'Use technical indicators in combination with sentiment analysis'
                            ];
                        }
                        
                        // Update tips list
                        tipsElement.innerHTML = '';
                        tips.forEach(tip => {
                            const li = document.createElement('li');
                            li.textContent = tip;
                            tipsElement.appendChild(li);
                        });
                    }, 500);
                });
        }
        
        // Update sentiment when stock data is loaded
        const originalFetchStockData = fetchStockData;
        fetchStockData = function(symbol) {
            originalFetchStockData(symbol);
            fetchSentimentData(symbol);
        };
        
        // Live price refresh functionality
        let priceRefreshInterval;
        
        // Start automatic price refresh (every 30 seconds)
        function startLivePriceRefresh() {
            // Clear any existing interval
            if (priceRefreshInterval) {
                clearInterval(priceRefreshInterval);
            }
            
            // Set up new interval
            priceRefreshInterval = setInterval(() => {
                const symbol = document.getElementById('symbol').value.trim().toUpperCase();
                if (symbol) {
                    console.log('Refreshing live price for:', symbol);
                    fetchStockData(symbol);
                }
            }, 30000); // 30 seconds
            
            console.log('Live price refresh started');
        }
        
        // Stop automatic price refresh
        function stopLivePriceRefresh() {
            if (priceRefreshInterval) {
                clearInterval(priceRefreshInterval);
                priceRefreshInterval = null;
                console.log('Live price refresh stopped');
            }
        }
        
        // Toggle live price refresh
        function toggleLivePriceRefresh() {
            const toggleButton = document.getElementById('toggleLiveRefresh');
            if (toggleButton) {
                if (priceRefreshInterval) {
                    // Currently running, so stop it
                    stopLivePriceRefresh();
                    toggleButton.textContent = 'üîÑ Start Live Updates';
                    toggleButton.className = toggleButton.className.replace('active', '');
                } else {
                    // Currently stopped, so start it
                    startLivePriceRefresh();
                    toggleButton.textContent = '‚è∏Ô∏è Stop Live Updates';
                    toggleButton.className += ' active';
                }
            }
        }
        
        // Start live refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startLivePriceRefresh();
        });
        
        // Clean up interval when page is unloaded
        window.addEventListener('beforeunload', function() {
            stopLivePriceRefresh();
        });
    </script>

    <div id="notification" class="notification"></div>
</body>
</html>